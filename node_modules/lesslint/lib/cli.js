'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.parse = parse;

var _fs = require('fs');

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _edpCore = require('edp-core');

var _package = require('../package');

var _package2 = _interopRequireDefault(_package);

var _util = require('./util');

var _checker = require('./checker');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @file 命令行功能模块
 * @author ielgnaw(wuji0223@gmail.com)
 */

'use strict';

/**
 * 显示默认的信息
 */
var showDefaultInfo = function showDefaultInfo() {
    console.warn(_package2.default);
    console.log('');
    console.log(_package2.default.name + ' v' + _package2.default.version);
    console.log(_chalk2.default.bold.green((0, _util.formatMsg)(_package2.default.description)));
};

/**
 * 校验结果报告
 *
 * @inner
 * @param {Object} errors 按文件类型为 key，值为对应的校验错误信息列表的对象
 */
var report = function report(errors) {
    var t12 = true;

    if (errors.length) {
        errors.forEach(function (error) {
            _edpCore.log.info(error.path);
            error.messages.sort(function (left, right) {
                return left.line - right.line;
            });
            error.messages.forEach(function (message) {
                var ruleName = message.ruleName || '';
                var msg = '→ ' + (ruleName ? _chalk2.default.bold(ruleName) + ': ' : '');
                // 全局性的错误可能没有位置信息
                if (typeof message.line === 'number') {
                    msg += 'line ' + message.line;
                    if (typeof message.col === 'number') {
                        msg += ', col ' + message.col;
                    }
                    msg += ': ';
                }

                msg += message.colorMessage || message.message;
                _edpCore.log.warn(msg);
            });
        });
        t12 = false;
    }

    if (t12) {
        _edpCore.log.info('Congratulations! Everything gone well, you are T12!');
    } else {
        process.exit(1);
    }
};

/**
 * 解析参数。作为命令行执行的入口
 *
 * @param {Array} args 参数列表
 */
function parse(args) {
    args = args.slice(2);

    // 不带参数时，默认检测当前目录下所有的 less 文件
    if (args.length === 0) {
        args.push('.');
    }

    if (args[0] === '--version' || args[0] === '-v') {
        showDefaultInfo();
        return;
    }

    var patterns = ['**/*.less', '!**/{output,test,node_modules,asset,dist,release,doc,dep,report}/**'];

    var candidates = (0, _util.getCandidates)(args, patterns);

    var count = candidates.length;

    if (!count) {
        return;
    }

    // 错误信息的集合
    var errors = [];

    /**
     * 每个文件的校验结果回调，主要用于统计校验完成情况
     *
     * @inner
     */
    var callback = function callback() {
        count--;
        if (!count) {
            report(errors);
        }
    };

    // 遍历每个需要检测的 less 文件
    candidates.forEach(function (candidate) {
        var readable = (0, _fs.createReadStream)(candidate, {
            encoding: 'utf8'
        });
        readable.on('data', function (chunk) {
            var file = {
                content: chunk,
                path: candidate
            };
            (0, _checker.check)(file, errors, callback);
        });
        readable.on('error', function (err) {
            throw err;
        });
    });
}
//# sourceMappingURL=data:application/json;base64,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RUFBb0IsaUJBQVM7QUFDekIsZ0JBQU0sT0FBTztBQUNULHlCQUFTLEtBREE7QUFFVCxzQkFBTTtBQUZHLGFBQWI7QUFJQSxnQ0FBTSxJQUFOLEVBQVksTUFBWixFQUFvQixRQUFwQjtBQUNILFNBTkQ7QUFPQSxpQkFBUyxFQUFULENBQVksT0FBWixFQUFxQixlQUFPO0FBQ3hCLGtCQUFNLEdBQU47QUFDSCxTQUZEO0FBR0gsS0FkRDtBQWVIIiwiZmlsZSI6ImNsaS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUg5ZG95Luk6KGM5Yqf6IO95qih5Z2XXG4gKiBAYXV0aG9yIGllbGduYXcod3VqaTAyMjNAZ21haWwuY29tKVxuICovXG5cbmltcG9ydCB7Y3JlYXRlUmVhZFN0cmVhbX0gZnJvbSAnZnMnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCB7bG9nfSBmcm9tICdlZHAtY29yZSc7XG5pbXBvcnQgc3lzIGZyb20gJy4uL3BhY2thZ2UnO1xuaW1wb3J0IHtmb3JtYXRNc2csIGdldENhbmRpZGF0ZXN9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQge2NoZWNrfSBmcm9tICcuL2NoZWNrZXInO1xuXG4ndXNlIHN0cmljdCc7XG5cbi8qKlxuICog5pi+56S66buY6K6k55qE5L+h5oGvXG4gKi9cbmNvbnN0IHNob3dEZWZhdWx0SW5mbyA9ICgpID0+IHtcbiAgICBjb25zb2xlLndhcm4oc3lzKTtcbiAgICBjb25zb2xlLmxvZygnJyk7XG4gICAgY29uc29sZS5sb2coKHN5cy5uYW1lICsgJyB2JyArIHN5cy52ZXJzaW9uKSk7XG4gICAgY29uc29sZS5sb2coY2hhbGsuYm9sZC5ncmVlbihmb3JtYXRNc2coc3lzLmRlc2NyaXB0aW9uKSkpO1xufTtcblxuXG4vKipcbiAqIOagoemqjOe7k+aenOaKpeWRilxuICpcbiAqIEBpbm5lclxuICogQHBhcmFtIHtPYmplY3R9IGVycm9ycyDmjInmlofku7bnsbvlnovkuLoga2V577yM5YC85Li65a+55bqU55qE5qCh6aqM6ZSZ6K+v5L+h5oGv5YiX6KGo55qE5a+56LGhXG4gKi9cbmNvbnN0IHJlcG9ydCA9IGVycm9ycyA9PiB7XG4gICAgbGV0IHQxMiA9IHRydWU7XG5cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCkge1xuICAgICAgICBlcnJvcnMuZm9yRWFjaChlcnJvciA9PiB7XG4gICAgICAgICAgICBsb2cuaW5mbyhlcnJvci5wYXRoKTtcbiAgICAgICAgICAgIGVycm9yLm1lc3NhZ2VzLnNvcnQoKGxlZnQsIHJpZ2h0KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQubGluZSAtIHJpZ2h0LmxpbmU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGVycm9yLm1lc3NhZ2VzLmZvckVhY2gobWVzc2FnZSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSBtZXNzYWdlLnJ1bGVOYW1lIHx8ICcnO1xuICAgICAgICAgICAgICAgIGxldCBtc2cgPSAn4oaSICcgKyAocnVsZU5hbWUgPyBjaGFsay5ib2xkKHJ1bGVOYW1lKSArICc6ICcgOiAnJyk7XG4gICAgICAgICAgICAgICAgLy8g5YWo5bGA5oCn55qE6ZSZ6K+v5Y+v6IO95rKh5pyJ5L2N572u5L+h5oGvXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlLmxpbmUgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIG1zZyArPSAoJ2xpbmUgJyArIG1lc3NhZ2UubGluZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZS5jb2wgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtc2cgKz0gKCcsIGNvbCAnICsgbWVzc2FnZS5jb2wpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG1zZyArPSAnOiAnO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIG1zZyArPSBtZXNzYWdlLmNvbG9yTWVzc2FnZSB8fCBtZXNzYWdlLm1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgbG9nLndhcm4obXNnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdDEyID0gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHQxMikge1xuICAgICAgICBsb2cuaW5mbygnQ29uZ3JhdHVsYXRpb25zISBFdmVyeXRoaW5nIGdvbmUgd2VsbCwgeW91IGFyZSBUMTIhJyk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfVxufTtcblxuXG4vKipcbiAqIOino+aekOWPguaVsOOAguS9nOS4uuWRveS7pOihjOaJp+ihjOeahOWFpeWPo1xuICpcbiAqIEBwYXJhbSB7QXJyYXl9IGFyZ3Mg5Y+C5pWw5YiX6KGoXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZShhcmdzKSB7XG4gICAgYXJncyA9IGFyZ3Muc2xpY2UoMik7XG5cbiAgICAvLyDkuI3luKblj4LmlbDml7bvvIzpu5jorqTmo4DmtYvlvZPliY3nm67lvZXkuIvmiYDmnInnmoQgbGVzcyDmlofku7ZcbiAgICBpZiAoYXJncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgYXJncy5wdXNoKCcuJyk7XG4gICAgfVxuXG4gICAgaWYgKGFyZ3NbMF0gPT09ICctLXZlcnNpb24nIHx8IGFyZ3NbMF0gPT09ICctdicpIHtcbiAgICAgICAgc2hvd0RlZmF1bHRJbmZvKCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwYXR0ZXJucyA9IFtcbiAgICAgICAgJyoqLyoubGVzcycsXG4gICAgICAgICchKiove291dHB1dCx0ZXN0LG5vZGVfbW9kdWxlcyxhc3NldCxkaXN0LHJlbGVhc2UsZG9jLGRlcCxyZXBvcnR9LyoqJ1xuICAgIF07XG5cbiAgICBjb25zdCBjYW5kaWRhdGVzID0gZ2V0Q2FuZGlkYXRlcyhhcmdzLCBwYXR0ZXJucyk7XG5cbiAgICBsZXQgY291bnQgPSBjYW5kaWRhdGVzLmxlbmd0aDtcblxuICAgIGlmICghY291bnQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIOmUmeivr+S/oeaBr+eahOmbhuWQiFxuICAgIGNvbnN0IGVycm9ycyA9IFtdO1xuXG4gICAgLyoqXG4gICAgICog5q+P5Liq5paH5Lu255qE5qCh6aqM57uT5p6c5Zue6LCD77yM5Li76KaB55So5LqO57uf6K6h5qCh6aqM5a6M5oiQ5oOF5Ya1XG4gICAgICpcbiAgICAgKiBAaW5uZXJcbiAgICAgKi9cbiAgICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHtcbiAgICAgICAgY291bnQtLTtcbiAgICAgICAgaWYgKCFjb3VudCkge1xuICAgICAgICAgICAgcmVwb3J0KGVycm9ycyk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8g6YGN5Y6G5q+P5Liq6ZyA6KaB5qOA5rWL55qEIGxlc3Mg5paH5Lu2XG4gICAgY2FuZGlkYXRlcy5mb3JFYWNoKGNhbmRpZGF0ZSA9PiB7XG4gICAgICAgIGNvbnN0IHJlYWRhYmxlID0gY3JlYXRlUmVhZFN0cmVhbShjYW5kaWRhdGUsIHtcbiAgICAgICAgICAgIGVuY29kaW5nOiAndXRmOCdcbiAgICAgICAgfSk7XG4gICAgICAgIHJlYWRhYmxlLm9uKCdkYXRhJywgY2h1bmsgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHtcbiAgICAgICAgICAgICAgICBjb250ZW50OiBjaHVuayxcbiAgICAgICAgICAgICAgICBwYXRoOiBjYW5kaWRhdGVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjaGVjayhmaWxlLCBlcnJvcnMsIGNhbGxiYWNrKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlYWRhYmxlLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuIl19