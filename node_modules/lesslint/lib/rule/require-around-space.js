'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _postcssValuesParser = require('postcss-values-parser');

var _postcssValuesParser2 = _interopRequireDefault(_postcssValuesParser);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @file 运算符检验
 *       + / - / * / / 四个运算符两侧必须（MUST）保留一个空格。
 *       https://github.com/ecomfe/spec/blob/master/less-code-style.md#%E8%BF%90%E7%AE%97
 * @author ielgnaw(wuji0223@gmail.com)
 */

'use strict';

/**
 * 规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'require-around-space';

/**
 * 错误信息
 *
 * @const
 * @type {string}
 */
var MSG = '`+`、`-`、`*`、`/` four operators on both sides must keep a space';

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        if (!opts.ruleVal) {
            return;
        }

        /* jshint maxcomplexity:false */
        css.walkDecls(function (decl) {
            var valueAst = (0, _postcssValuesParser2.default)(decl.value).parse();

            valueAst.walk(function (child) {
                if (child.type !== 'operator') {
                    return;
                }

                var parent = child.parent;

                // 当前 child 的索引

                var index = parent.index(child);

                // child 的后一个元素
                var nextElem = parent.nodes[index + 1];

                // child 的前一个元素
                var prevElem = parent.nodes[index - 1];

                // 忽略负数 -1
                if (child.value === '-' && (child.raws.before || decl.raws.between) && nextElem.type === 'number' && !nextElem.raws.before) {
                    return;
                }

                // 忽略变量 -@foo
                if (child.value === '-' && (child.raws.before || decl.raws.between) && nextElem.type === 'atword' && !nextElem.raws.before) {
                    return;
                }

                // 忽略 font-size/line-height 简写定义
                if (decl.prop === 'font' && child.value === '/' && prevElem.type === 'number' && nextElem.type === 'number') {
                    return;
                }

                // 判断 operator 前面是否有空格
                var isBeforeValid = child.raws.before === ' ' || /^\s/.test(child.raws.before);

                // 判断 operator 后面是否有空格
                var isAfterValid = nextElem.raws.before === ' ' || /\s$/.test(nextElem.raws.before);

                if (!isBeforeValid || !isAfterValid) {
                    var problemElem = !/\s$/.test(child.raws.before) ? child : nextElem;
                    var source = decl.source;
                    var prop = decl.prop;
                    var raws = decl.raws;

                    var line = source.start.line;
                    var lineContent = (0, _util.getLineContent)(line, source.input.css, true);
                    var col = 0 + source.start.column + prop.length + raws.between.length + problemElem.source.start.column - 1 - (isBeforeValid ? child.value.length : 0);

                    result.warn(RULENAME, {
                        node: decl,
                        ruleName: RULENAME,
                        line: line,
                        col: col,
                        message: '`' + lineContent + '` ' + MSG,
                        colorMessage: '`' + (0, _util.changeColorByStartAndEndIndex)(lineContent, col, col + child.value.length) + '` ' + _chalk2.default.grey(MSG)
                    });
                }
            });
        });
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3JlcXVpcmUtYXJvdW5kLXNwYWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFPQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQVhBOzs7Ozs7O0FBYUE7O0FBRUE7Ozs7OztBQU1BLElBQU0sV0FBVyxzQkFBakI7O0FBRUE7Ozs7OztBQU1BLElBQU0sTUFBTSxnRUFBWjs7QUFFQTs7Ozs7Ozs7QUFRTyxJQUFNLHdCQUFRLGtCQUFRLE1BQVIsQ0FBZSxRQUFmLEVBQXlCO0FBQUEsV0FDMUMsVUFBQyxHQUFELEVBQU0sTUFBTixFQUFpQjtBQUNiLFlBQUksQ0FBQyxLQUFLLE9BQVYsRUFBbUI7QUFDZjtBQUNIOztBQUVEO0FBQ0EsWUFBSSxTQUFKLENBQWMsZ0JBQVE7QUFDbEIsZ0JBQU0sV0FBVyxtQ0FBTyxLQUFLLEtBQVosRUFBbUIsS0FBbkIsRUFBakI7O0FBRUEscUJBQVMsSUFBVCxDQUFjLGlCQUFTO0FBQ25CLG9CQUFJLE1BQU0sSUFBTixLQUFlLFVBQW5CLEVBQStCO0FBQzNCO0FBQ0g7O0FBSGtCLG9CQUtaLE1BTFksR0FLRixLQUxFLENBS1osTUFMWTs7QUFPbkI7O0FBQ0Esb0JBQU0sUUFBUSxPQUFPLEtBQVAsQ0FBYSxLQUFiLENBQWQ7O0FBRUE7QUFDQSxvQkFBTSxXQUFXLE9BQU8sS0FBUCxDQUFhLFFBQVEsQ0FBckIsQ0FBakI7O0FBRUE7QUFDQSxvQkFBTSxXQUFXLE9BQU8sS0FBUCxDQUFhLFFBQVEsQ0FBckIsQ0FBakI7O0FBRUE7QUFDQSxvQkFBSSxNQUFNLEtBQU4sS0FBZ0IsR0FBaEIsS0FDSSxNQUFNLElBQU4sQ0FBVyxNQUFYLElBQXFCLEtBQUssSUFBTCxDQUFVLE9BRG5DLEtBRUcsU0FBUyxJQUFULEtBQWtCLFFBRnJCLElBR0csQ0FBQyxTQUFTLElBQVQsQ0FBYyxNQUh0QixFQUlFO0FBQ0U7QUFDSDs7QUFFRDtBQUNBLG9CQUFJLE1BQU0sS0FBTixLQUFnQixHQUFoQixLQUNJLE1BQU0sSUFBTixDQUFXLE1BQVgsSUFBcUIsS0FBSyxJQUFMLENBQVUsT0FEbkMsS0FFRyxTQUFTLElBQVQsS0FBa0IsUUFGckIsSUFHRyxDQUFDLFNBQVMsSUFBVCxDQUFjLE1BSHRCLEVBSUU7QUFDRTtBQUNIOztBQUVEO0FBQ0Esb0JBQUksS0FBSyxJQUFMLEtBQWMsTUFBZCxJQUNHLE1BQU0sS0FBTixLQUFnQixHQURuQixJQUVHLFNBQVMsSUFBVCxLQUFrQixRQUZyQixJQUdHLFNBQVMsSUFBVCxLQUFrQixRQUh6QixFQUlFO0FBQ0U7QUFDSDs7QUFFRDtBQUNBLG9CQUFNLGdCQUFnQixNQUFNLElBQU4sQ0FBVyxNQUFYLEtBQXNCLEdBQXRCLElBQTZCLE1BQU0sSUFBTixDQUFXLE1BQU0sSUFBTixDQUFXLE1BQXRCLENBQW5EOztBQUVBO0FBQ0Esb0JBQU0sZUFBZSxTQUFTLElBQVQsQ0FBYyxNQUFkLEtBQXlCLEdBQXpCLElBQWdDLE1BQU0sSUFBTixDQUFXLFNBQVMsSUFBVCxDQUFjLE1BQXpCLENBQXJEOztBQUVBLG9CQUFJLENBQUMsYUFBRCxJQUFrQixDQUFDLFlBQXZCLEVBQXFDO0FBQ2pDLHdCQUFNLGNBQWMsQ0FBQyxNQUFNLElBQU4sQ0FBVyxNQUFNLElBQU4sQ0FBVyxNQUF0QixDQUFELEdBQWlDLEtBQWpDLEdBQXlDLFFBQTdEO0FBRGlDLHdCQUUxQixNQUYwQixHQUVKLElBRkksQ0FFMUIsTUFGMEI7QUFBQSx3QkFFbEIsSUFGa0IsR0FFSixJQUZJLENBRWxCLElBRmtCO0FBQUEsd0JBRVosSUFGWSxHQUVKLElBRkksQ0FFWixJQUZZOztBQUdqQyx3QkFBTSxPQUFPLE9BQU8sS0FBUCxDQUFhLElBQTFCO0FBQ0Esd0JBQU0sY0FBYywwQkFBZSxJQUFmLEVBQXFCLE9BQU8sS0FBUCxDQUFhLEdBQWxDLEVBQXVDLElBQXZDLENBQXBCO0FBQ0Esd0JBQU0sTUFBTSxJQUNOLE9BQU8sS0FBUCxDQUFhLE1BRFAsR0FDZ0IsS0FBSyxNQURyQixHQUM4QixLQUFLLE9BQUwsQ0FBYSxNQUQzQyxHQUNvRCxZQUFZLE1BQVosQ0FBbUIsS0FBbkIsQ0FBeUIsTUFEN0UsR0FFTixDQUZNLElBR0wsZ0JBQWdCLE1BQU0sS0FBTixDQUFZLE1BQTVCLEdBQXFDLENBSGhDLENBQVo7O0FBS0EsMkJBQU8sSUFBUCxDQUFZLFFBQVosRUFBc0I7QUFDbEIsOEJBQU0sSUFEWTtBQUVsQixrQ0FBVSxRQUZRO0FBR2xCLDhCQUFNLElBSFk7QUFJbEIsNkJBQUssR0FKYTtBQUtsQixpQ0FBUyxNQUFNLFdBQU4sR0FBb0IsSUFBcEIsR0FBMkIsR0FMbEI7QUFNbEIsc0NBQWMsTUFDUix5Q0FBOEIsV0FBOUIsRUFBMkMsR0FBM0MsRUFBZ0QsTUFBTSxNQUFNLEtBQU4sQ0FBWSxNQUFsRSxDQURRLEdBRVIsSUFGUSxHQUdSLGdCQUFNLElBQU4sQ0FBVyxHQUFYO0FBVFkscUJBQXRCO0FBV0g7QUFDSixhQXZFRDtBQXdFSCxTQTNFRDtBQTRFSCxLQW5GeUM7QUFBQSxDQUF6QixDQUFkIiwiZmlsZSI6InJlcXVpcmUtYXJvdW5kLXNwYWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSDov5DnrpfnrKbmo4DpqoxcbiAqICAgICAgICsgLyAtIC8gKiAvIC8g5Zub5Liq6L+Q566X56ym5Lik5L6n5b+F6aG777yITVVTVO+8ieS/neeVmeS4gOS4quepuuagvOOAglxuICogICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2Vjb21mZS9zcGVjL2Jsb2IvbWFzdGVyL2xlc3MtY29kZS1zdHlsZS5tZCMlRTglQkYlOTAlRTclQUUlOTdcbiAqIEBhdXRob3IgaWVsZ25hdyh3dWppMDIyM0BnbWFpbC5jb20pXG4gKi9cblxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwb3N0Y3NzIGZyb20gJ3Bvc3Rjc3MnO1xuaW1wb3J0IHBhcnNlciBmcm9tICdwb3N0Y3NzLXZhbHVlcy1wYXJzZXInO1xuXG5pbXBvcnQge2dldExpbmVDb250ZW50LCBjaGFuZ2VDb2xvckJ5U3RhcnRBbmRFbmRJbmRleH0gZnJvbSAnLi4vdXRpbCc7XG5cbid1c2Ugc3RyaWN0JztcblxuLyoqXG4gKiDop4TliJnlkI3np7BcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IFJVTEVOQU1FID0gJ3JlcXVpcmUtYXJvdW5kLXNwYWNlJztcblxuLyoqXG4gKiDplJnor6/kv6Hmga9cbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IE1TRyA9ICdgK2DjgIFgLWDjgIFgKmDjgIFgL2AgZm91ciBvcGVyYXRvcnMgb24gYm90aCBzaWRlcyBtdXN0IGtlZXAgYSBzcGFjZSc7XG5cbi8qKlxuICog5YW35L2T55qE5qOA5rWL6YC76L6RXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMg5Y+C5pWwXG4gKiBAcGFyYW0geyp9IG9wdHMucnVsZVZhbCDlvZPliY3op4TliJnlhbfkvZPphY3nva7nmoTlgLxcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRzLmZpbGVDb250ZW50IOaWh+S7tuWGheWuuVxuICogQHBhcmFtIHtzdHJpbmd9IG9wdHMuZmlsZVBhdGgg5paH5Lu26Lev5b6EXG4gKi9cbmV4cG9ydCBjb25zdCBjaGVjayA9IHBvc3Rjc3MucGx1Z2luKFJVTEVOQU1FLCBvcHRzID0+XG4gICAgKGNzcywgcmVzdWx0KSA9PiB7XG4gICAgICAgIGlmICghb3B0cy5ydWxlVmFsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvKiBqc2hpbnQgbWF4Y29tcGxleGl0eTpmYWxzZSAqL1xuICAgICAgICBjc3Mud2Fsa0RlY2xzKGRlY2wgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsdWVBc3QgPSBwYXJzZXIoZGVjbC52YWx1ZSkucGFyc2UoKTtcblxuICAgICAgICAgICAgdmFsdWVBc3Qud2FsayhjaGlsZCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkLnR5cGUgIT09ICdvcGVyYXRvcicpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IHtwYXJlbnR9ID0gY2hpbGQ7XG5cbiAgICAgICAgICAgICAgICAvLyDlvZPliY0gY2hpbGQg55qE57Si5byVXG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBwYXJlbnQuaW5kZXgoY2hpbGQpO1xuXG4gICAgICAgICAgICAgICAgLy8gY2hpbGQg55qE5ZCO5LiA5Liq5YWD57SgXG4gICAgICAgICAgICAgICAgY29uc3QgbmV4dEVsZW0gPSBwYXJlbnQubm9kZXNbaW5kZXggKyAxXTtcblxuICAgICAgICAgICAgICAgIC8vIGNoaWxkIOeahOWJjeS4gOS4quWFg+e0oFxuICAgICAgICAgICAgICAgIGNvbnN0IHByZXZFbGVtID0gcGFyZW50Lm5vZGVzW2luZGV4IC0gMV07XG5cbiAgICAgICAgICAgICAgICAvLyDlv73nlaXotJ/mlbAgLTFcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQudmFsdWUgPT09ICctJ1xuICAgICAgICAgICAgICAgICAgICAmJiAoY2hpbGQucmF3cy5iZWZvcmUgfHwgZGVjbC5yYXdzLmJldHdlZW4pXG4gICAgICAgICAgICAgICAgICAgICYmIG5leHRFbGVtLnR5cGUgPT09ICdudW1iZXInXG4gICAgICAgICAgICAgICAgICAgICYmICFuZXh0RWxlbS5yYXdzLmJlZm9yZVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8g5b+955Wl5Y+Y6YePIC1AZm9vXG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkLnZhbHVlID09PSAnLSdcbiAgICAgICAgICAgICAgICAgICAgJiYgKGNoaWxkLnJhd3MuYmVmb3JlIHx8IGRlY2wucmF3cy5iZXR3ZWVuKVxuICAgICAgICAgICAgICAgICAgICAmJiBuZXh0RWxlbS50eXBlID09PSAnYXR3b3JkJ1xuICAgICAgICAgICAgICAgICAgICAmJiAhbmV4dEVsZW0ucmF3cy5iZWZvcmVcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIOW/veeVpSBmb250LXNpemUvbGluZS1oZWlnaHQg566A5YaZ5a6a5LmJXG4gICAgICAgICAgICAgICAgaWYgKGRlY2wucHJvcCA9PT0gJ2ZvbnQnXG4gICAgICAgICAgICAgICAgICAgICYmIGNoaWxkLnZhbHVlID09PSAnLydcbiAgICAgICAgICAgICAgICAgICAgJiYgcHJldkVsZW0udHlwZSA9PT0gJ251bWJlcidcbiAgICAgICAgICAgICAgICAgICAgJiYgbmV4dEVsZW0udHlwZSA9PT0gJ251bWJlcidcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIOWIpOaWrSBvcGVyYXRvciDliY3pnaLmmK/lkKbmnInnqbrmoLxcbiAgICAgICAgICAgICAgICBjb25zdCBpc0JlZm9yZVZhbGlkID0gY2hpbGQucmF3cy5iZWZvcmUgPT09ICcgJyB8fCAvXlxccy8udGVzdChjaGlsZC5yYXdzLmJlZm9yZSk7XG5cbiAgICAgICAgICAgICAgICAvLyDliKTmlq0gb3BlcmF0b3Ig5ZCO6Z2i5piv5ZCm5pyJ56m65qC8XG4gICAgICAgICAgICAgICAgY29uc3QgaXNBZnRlclZhbGlkID0gbmV4dEVsZW0ucmF3cy5iZWZvcmUgPT09ICcgJyB8fCAvXFxzJC8udGVzdChuZXh0RWxlbS5yYXdzLmJlZm9yZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWlzQmVmb3JlVmFsaWQgfHwgIWlzQWZ0ZXJWYWxpZCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9ibGVtRWxlbSA9ICEvXFxzJC8udGVzdChjaGlsZC5yYXdzLmJlZm9yZSkgPyBjaGlsZCA6IG5leHRFbGVtO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7c291cmNlLCBwcm9wLCByYXdzfSA9IGRlY2w7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluZUNvbnRlbnQgPSBnZXRMaW5lQ29udGVudChsaW5lLCBzb3VyY2UuaW5wdXQuY3NzLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sID0gMFxuICAgICAgICAgICAgICAgICAgICAgICAgKyBzb3VyY2Uuc3RhcnQuY29sdW1uICsgcHJvcC5sZW5ndGggKyByYXdzLmJldHdlZW4ubGVuZ3RoICsgcHJvYmxlbUVsZW0uc291cmNlLnN0YXJ0LmNvbHVtblxuICAgICAgICAgICAgICAgICAgICAgICAgLSAxXG4gICAgICAgICAgICAgICAgICAgICAgICAtIChpc0JlZm9yZVZhbGlkID8gY2hpbGQudmFsdWUubGVuZ3RoIDogMCk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm4oUlVMRU5BTUUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGRlY2wsXG4gICAgICAgICAgICAgICAgICAgICAgICBydWxlTmFtZTogUlVMRU5BTUUsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnYCcgKyBsaW5lQ29udGVudCArICdgICcgKyBNU0csXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6ICdgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbmdlQ29sb3JCeVN0YXJ0QW5kRW5kSW5kZXgobGluZUNvbnRlbnQsIGNvbCwgY29sICsgY2hpbGQudmFsdWUubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgJ2AgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbGsuZ3JleShNU0cpXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4pO1xuIl19