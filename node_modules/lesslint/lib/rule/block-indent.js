'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

'use strict';

/**
 * 规则名称
 *
 * @const
 * @type {string}
 */
/**
 * @file 缩进校验
 *       必须（MUST）采用 4 个空格为一次缩进， 不得（MUST NOT）采用 TAB 作为缩进。
 *       https://github.com/ecomfe/spec/blob/master/less-code-style.md#%E5%B5%8C%E5%A5%97%E5%92%8C%E7%BC%A9%E8%BF%9B
 * @author ielgnaw(wuji0223@gmail.com)
 */

var RULENAME = 'block-indent';

/**
 * 行号的缓存，防止同一行多次报错
 *
 * @type {number}
 */
var lineCache = 0;

/**
 * 获取错误信息
 *
 * @param {string} curIndent 当前的缩进（错误的）
 * @param {string} neededIndent 期望的的缩进（正确的）
 *
 * @return {string} 错误信息
 */
var getMsg = function getMsg(curIndent, neededIndent) {
    return '' + 'Bad indentation, Expected `' + neededIndent + '` but saw `' + curIndent + '`';
};

/**
 * 添加报错信息
 *
 * @param {Object} node node 对象，可能是 decl 也可能是 rule
 * @param {Object} result postcss 转换的结果对象
 * @param {string} msg 错误信息
 * @param {string} hackPrefixChar 属性 hack 的前缀，`_` 或者 `*`
 */
var addWarn = function addWarn(node, result, msg) {
    var hackPrefixChar = arguments.length <= 3 || arguments[3] === undefined ? '' : arguments[3];

    var source = node.source;
    var line = source.start.line;
    if (lineCache !== line) {
        lineCache = line;
        var col = source.start.column;

        var lineContent = (0, _util.getLineContent)(line, source.input.css) || '';
        var colorStr = '';

        if (node.selector) {
            colorStr = node.selector;
        } else if (node.type === 'atrule') {
            colorStr = lineContent;
        } else {
            colorStr = hackPrefixChar + node.prop + node.raws.between + node.value;
            colorStr = colorStr.replace(/\n/g, '');
        }

        result.warn(RULENAME, {
            node: node,
            ruleName: RULENAME,
            line: line,
            col: col,
            message: msg,
            colorMessage: '`' + lineContent.replace(colorStr, _chalk2.default.magenta(colorStr)) + '` ' + _chalk2.default.grey(msg)
        });
    }
};

/**
 * 遍历 ruleList，为了分析 decl
 *
 * @param {Array} ruleList rule 集合
 * @param {Object} result postcss 转换的结果对象
 */
var ruleListIterator = function ruleListIterator(ruleList, result) {
    ruleList.forEach(function (r) {
        var rule = r.node;
        var indentStr = r.indentStr;
        if (rule.nodes && rule.nodes.length) {
            // 属性要比它所属的选择器多一层缩进
            indentStr += '    ';
            rule.nodes.forEach(function (childNode) {
                if (childNode.type !== 'decl') {
                    return;
                }

                var curIndent = childNode.raws.before.replace(/\n*/, '').length;
                var neededIndent = indentStr.length;
                if (curIndent !== neededIndent) {
                    addWarn(childNode, result, getMsg(curIndent + 1, neededIndent + 1));
                }
            });
        }
    });
};

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        if (!opts.ruleVal) {
            return;
        }

        lineCache = 0;

        // 收集顶层变量定义
        css.walkDecls(function (decl) {
            if (decl.parent.type === 'root') {
                var curIndent = decl.raws.before.replace(/\n*/, '').length;
                var neededIndent = 0;
                if (curIndent !== neededIndent) {
                    addWarn(decl, result, getMsg(curIndent + 1, neededIndent + 1));
                }
            }
        });

        var ruleList = [];

        var analyzeIndent = function analyzeIndent(rule, indentStr) {
            if (rule.type !== 'rule') {
                return;
            }

            var curIndent = rule.raws.before.replace(/\n*/, '').length;
            var neededIndent = indentStr.length;
            if (curIndent !== neededIndent) {
                addWarn(rule, result, getMsg(curIndent + 1, neededIndent + 1));
            }

            ruleList.push({
                node: rule,
                indentStr: indentStr
            });

            if (rule.nodes && rule.nodes.length) {
                rule.nodes.forEach(function (r) {
                    analyzeIndent(r, indentStr + '    ');
                });
            }
        };

        // 收集顶层选择器
        css.walkRules(function (rule) {
            if (rule.parent.type === 'root') {
                analyzeIndent(rule, '');
            }
        });

        ruleListIterator(ruleList, result);
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL2Jsb2NrLWluZGVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBT0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7O0FBRUE7Ozs7OztBQWJBOzs7Ozs7O0FBbUJBLElBQU0sV0FBVyxjQUFqQjs7QUFFQTs7Ozs7QUFLQSxJQUFJLFlBQVksQ0FBaEI7O0FBRUE7Ozs7Ozs7O0FBUUEsSUFBTSxTQUFTLFNBQVQsTUFBUyxDQUFDLFNBQUQsRUFBWSxZQUFaO0FBQUEsV0FBNkIsS0FDdEMsNkJBRHNDLEdBRXJDLFlBRnFDLEdBR3RDLGFBSHNDLEdBSXJDLFNBSnFDLEdBS3RDLEdBTFM7QUFBQSxDQUFmOztBQU9BOzs7Ozs7OztBQVFBLElBQU0sVUFBVSxTQUFWLE9BQVUsQ0FBQyxJQUFELEVBQU8sTUFBUCxFQUFlLEdBQWYsRUFBNEM7QUFBQSxRQUF4QixjQUF3Qix5REFBUCxFQUFPOztBQUN4RCxRQUFNLFNBQVMsS0FBSyxNQUFwQjtBQUNBLFFBQU0sT0FBTyxPQUFPLEtBQVAsQ0FBYSxJQUExQjtBQUNBLFFBQUksY0FBYyxJQUFsQixFQUF3QjtBQUNwQixvQkFBWSxJQUFaO0FBQ0EsWUFBTSxNQUFNLE9BQU8sS0FBUCxDQUFhLE1BQXpCOztBQUVBLFlBQUksY0FBYywwQkFBZSxJQUFmLEVBQXFCLE9BQU8sS0FBUCxDQUFhLEdBQWxDLEtBQTBDLEVBQTVEO0FBQ0EsWUFBSSxXQUFXLEVBQWY7O0FBRUEsWUFBSSxLQUFLLFFBQVQsRUFBbUI7QUFDZix1QkFBVyxLQUFLLFFBQWhCO0FBQ0gsU0FGRCxNQUdLLElBQUksS0FBSyxJQUFMLEtBQWMsUUFBbEIsRUFBNEI7QUFDN0IsdUJBQVcsV0FBWDtBQUNILFNBRkksTUFHQTtBQUNELHVCQUFXLGlCQUFpQixLQUFLLElBQXRCLEdBQTZCLEtBQUssSUFBTCxDQUFVLE9BQXZDLEdBQWlELEtBQUssS0FBakU7QUFDQSx1QkFBVyxTQUFTLE9BQVQsQ0FBaUIsS0FBakIsRUFB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QixrQ0FBYyxDQUFkLEVBQWlCLFlBQVksTUFBN0I7QUFDSCxpQkFGRDtBQUdIO0FBQ0osU0FyQkQ7O0FBdUJBO0FBQ0EsWUFBSSxTQUFKLENBQWMsZ0JBQVE7QUFDbEIsZ0JBQUksS0FBSyxNQUFMLENBQVksSUFBWixLQUFxQixNQUF6QixFQUFpQztBQUM3Qiw4QkFBYyxJQUFkLEVBQW9CLEVBQXBCO0FBQ0g7QUFDSixTQUpEOztBQU1BLHlCQUFpQixRQUFqQixFQUEyQixNQUEzQjtBQUVILEtBckR5QztBQUFBLENBQXpCLENBQWQiLCJmaWxlIjoiYmxvY2staW5kZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSDnvKnov5vmoKHpqoxcbiAqICAgICAgIOW/hemhu++8iE1VU1TvvInph4fnlKggNCDkuKrnqbrmoLzkuLrkuIDmrKHnvKnov5vvvIwg5LiN5b6X77yITVVTVCBOT1TvvInph4fnlKggVEFCIOS9nOS4uue8qei/m+OAglxuICogICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2Vjb21mZS9zcGVjL2Jsb2IvbWFzdGVyL2xlc3MtY29kZS1zdHlsZS5tZCMlRTUlQjUlOEMlRTUlQTUlOTclRTUlOTIlOEMlRTclQkMlQTklRTglQkYlOUJcbiAqIEBhdXRob3IgaWVsZ25hdyh3dWppMDIyM0BnbWFpbC5jb20pXG4gKi9cblxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwb3N0Y3NzIGZyb20gJ3Bvc3Rjc3MnO1xuaW1wb3J0IHtnZXRMaW5lQ29udGVudH0gZnJvbSAnLi4vdXRpbCc7XG5cbid1c2Ugc3RyaWN0JztcblxuLyoqXG4gKiDop4TliJnlkI3np7BcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IFJVTEVOQU1FID0gJ2Jsb2NrLWluZGVudCc7XG5cbi8qKlxuICog6KGM5Y+355qE57yT5a2Y77yM6Ziy5q2i5ZCM5LiA6KGM5aSa5qyh5oql6ZSZXG4gKlxuICogQHR5cGUge251bWJlcn1cbiAqL1xubGV0IGxpbmVDYWNoZSA9IDA7XG5cbi8qKlxuICog6I635Y+W6ZSZ6K+v5L+h5oGvXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGN1ckluZGVudCDlvZPliY3nmoTnvKnov5vvvIjplJnor6/nmoTvvIlcbiAqIEBwYXJhbSB7c3RyaW5nfSBuZWVkZWRJbmRlbnQg5pyf5pyb55qE55qE57yp6L+b77yI5q2j56Gu55qE77yJXG4gKlxuICogQHJldHVybiB7c3RyaW5nfSDplJnor6/kv6Hmga9cbiAqL1xuY29uc3QgZ2V0TXNnID0gKGN1ckluZGVudCwgbmVlZGVkSW5kZW50KSA9PiAnJ1xuICAgICsgJ0JhZCBpbmRlbnRhdGlvbiwgRXhwZWN0ZWQgYCdcbiAgICArIChuZWVkZWRJbmRlbnQpXG4gICAgKyAnYCBidXQgc2F3IGAnXG4gICAgKyAoY3VySW5kZW50KVxuICAgICsgJ2AnO1xuXG4vKipcbiAqIOa3u+WKoOaKpemUmeS/oeaBr1xuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBub2RlIG5vZGUg5a+56LGh77yM5Y+v6IO95pivIGRlY2wg5Lmf5Y+v6IO95pivIHJ1bGVcbiAqIEBwYXJhbSB7T2JqZWN0fSByZXN1bHQgcG9zdGNzcyDovazmjaLnmoTnu5Pmnpzlr7nosaFcbiAqIEBwYXJhbSB7c3RyaW5nfSBtc2cg6ZSZ6K+v5L+h5oGvXG4gKiBAcGFyYW0ge3N0cmluZ30gaGFja1ByZWZpeENoYXIg5bGe5oCnIGhhY2sg55qE5YmN57yA77yMYF9gIOaIluiAhSBgKmBcbiAqL1xuY29uc3QgYWRkV2FybiA9IChub2RlLCByZXN1bHQsIG1zZywgaGFja1ByZWZpeENoYXIgPSAnJykgPT4ge1xuICAgIGNvbnN0IHNvdXJjZSA9IG5vZGUuc291cmNlO1xuICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICBpZiAobGluZUNhY2hlICE9PSBsaW5lKSB7XG4gICAgICAgIGxpbmVDYWNoZSA9IGxpbmU7XG4gICAgICAgIGNvbnN0IGNvbCA9IHNvdXJjZS5zdGFydC5jb2x1bW47XG5cbiAgICAgICAgbGV0IGxpbmVDb250ZW50ID0gZ2V0TGluZUNvbnRlbnQobGluZSwgc291cmNlLmlucHV0LmNzcykgfHwgJyc7XG4gICAgICAgIGxldCBjb2xvclN0ciA9ICcnO1xuXG4gICAgICAgIGlmIChub2RlLnNlbGVjdG9yKSB7XG4gICAgICAgICAgICBjb2xvclN0ciA9IG5vZGUuc2VsZWN0b3I7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAobm9kZS50eXBlID09PSAnYXRydWxlJykge1xuICAgICAgICAgICAgY29sb3JTdHIgPSBsaW5lQ29udGVudDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbG9yU3RyID0gaGFja1ByZWZpeENoYXIgKyBub2RlLnByb3AgKyBub2RlLnJhd3MuYmV0d2VlbiArIG5vZGUudmFsdWU7XG4gICAgICAgICAgICBjb2xvclN0ciA9IGNvbG9yU3RyLnJlcGxhY2UoL1xcbi9nLCAnJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgbm9kZTogbm9kZSxcbiAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICBjb2w6IGNvbCxcbiAgICAgICAgICAgIG1lc3NhZ2U6IG1zZyxcbiAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgKyBsaW5lQ29udGVudC5yZXBsYWNlKFxuICAgICAgICAgICAgICAgICAgICBjb2xvclN0cixcbiAgICAgICAgICAgICAgICAgICAgY2hhbGsubWFnZW50YShjb2xvclN0cilcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KG1zZylcbiAgICAgICAgfSk7XG4gICAgfVxufTtcblxuLyoqXG4gKiDpgY3ljoYgcnVsZUxpc3TvvIzkuLrkuobliIbmnpAgZGVjbFxuICpcbiAqIEBwYXJhbSB7QXJyYXl9IHJ1bGVMaXN0IHJ1bGUg6ZuG5ZCIXG4gKiBAcGFyYW0ge09iamVjdH0gcmVzdWx0IHBvc3Rjc3Mg6L2s5o2i55qE57uT5p6c5a+56LGhXG4gKi9cbmNvbnN0IHJ1bGVMaXN0SXRlcmF0b3IgPSAocnVsZUxpc3QsIHJlc3VsdCkgPT4ge1xuICAgIHJ1bGVMaXN0LmZvckVhY2gociA9PiB7XG4gICAgICAgIGNvbnN0IHJ1bGUgPSByLm5vZGU7XG4gICAgICAgIGxldCBpbmRlbnRTdHIgPSByLmluZGVudFN0cjtcbiAgICAgICAgaWYgKHJ1bGUubm9kZXMgJiYgcnVsZS5ub2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIOWxnuaAp+imgeavlOWug+aJgOWxnueahOmAieaLqeWZqOWkmuS4gOWxgue8qei/m1xuICAgICAgICAgICAgaW5kZW50U3RyICs9ICcgICAgJztcbiAgICAgICAgICAgIHJ1bGUubm9kZXMuZm9yRWFjaChjaGlsZE5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGUudHlwZSAhPT0gJ2RlY2wnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjdXJJbmRlbnQgPSBjaGlsZE5vZGUucmF3cy5iZWZvcmUucmVwbGFjZSgvXFxuKi8sICcnKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgY29uc3QgbmVlZGVkSW5kZW50ID0gaW5kZW50U3RyLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAoY3VySW5kZW50ICE9PSBuZWVkZWRJbmRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkV2FybihjaGlsZE5vZGUsIHJlc3VsdCwgZ2V0TXNnKGN1ckluZGVudCArIDEsIG5lZWRlZEluZGVudCArIDEpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuLyoqXG4gKiDlhbfkvZPnmoTmo4DmtYvpgLvovpFcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyDlj4LmlbBcbiAqIEBwYXJhbSB7Kn0gb3B0cy5ydWxlVmFsIOW9k+WJjeinhOWImeWFt+S9k+mFjee9rueahOWAvFxuICogQHBhcmFtIHtzdHJpbmd9IG9wdHMuZmlsZUNvbnRlbnQg5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlUGF0aCDmlofku7bot6/lvoRcbiAqL1xuZXhwb3J0IGNvbnN0IGNoZWNrID0gcG9zdGNzcy5wbHVnaW4oUlVMRU5BTUUsIG9wdHMgPT5cbiAgICAoY3NzLCByZXN1bHQpID0+IHtcbiAgICAgICAgaWYgKCFvcHRzLnJ1bGVWYWwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxpbmVDYWNoZSA9IDA7XG5cbiAgICAgICAgLy8g5pS26ZuG6aG25bGC5Y+Y6YeP5a6a5LmJXG4gICAgICAgIGNzcy53YWxrRGVjbHMoZGVjbCA9PiB7XG4gICAgICAgICAgICBpZiAoZGVjbC5wYXJlbnQudHlwZSA9PT0gJ3Jvb3QnKSB7XG4gICAgICAgICAgICAgICAgbGV0IGN1ckluZGVudCA9IGRlY2wucmF3cy5iZWZvcmUucmVwbGFjZSgvXFxuKi8sICcnKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgY29uc3QgbmVlZGVkSW5kZW50ID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoY3VySW5kZW50ICE9PSBuZWVkZWRJbmRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkV2FybihkZWNsLCByZXN1bHQsIGdldE1zZyhjdXJJbmRlbnQgKyAxLCBuZWVkZWRJbmRlbnQgKyAxKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBydWxlTGlzdCA9IFtdO1xuXG4gICAgICAgIGNvbnN0IGFuYWx5emVJbmRlbnQgPSAocnVsZSwgaW5kZW50U3RyKSA9PiB7XG4gICAgICAgICAgICBpZiAocnVsZS50eXBlICE9PSAncnVsZScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBjdXJJbmRlbnQgPSBydWxlLnJhd3MuYmVmb3JlLnJlcGxhY2UoL1xcbiovLCAnJykubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3QgbmVlZGVkSW5kZW50ID0gaW5kZW50U3RyLmxlbmd0aDtcbiAgICAgICAgICAgIGlmIChjdXJJbmRlbnQgIT09IG5lZWRlZEluZGVudCkge1xuICAgICAgICAgICAgICAgIGFkZFdhcm4ocnVsZSwgcmVzdWx0LCBnZXRNc2coY3VySW5kZW50ICsgMSwgbmVlZGVkSW5kZW50ICsgMSkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBydWxlTGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgICBub2RlOiBydWxlLFxuICAgICAgICAgICAgICAgIGluZGVudFN0cjogaW5kZW50U3RyXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHJ1bGUubm9kZXMgJiYgcnVsZS5ub2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBydWxlLm5vZGVzLmZvckVhY2gociA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5emVJbmRlbnQociwgaW5kZW50U3RyICsgJyAgICAnKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvLyDmlLbpm4bpobblsYLpgInmi6nlmahcbiAgICAgICAgY3NzLndhbGtSdWxlcyhydWxlID0+IHtcbiAgICAgICAgICAgIGlmIChydWxlLnBhcmVudC50eXBlID09PSAncm9vdCcpIHtcbiAgICAgICAgICAgICAgICBhbmFseXplSW5kZW50KHJ1bGUsICcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcnVsZUxpc3RJdGVyYXRvcihydWxlTGlzdCwgcmVzdWx0KTtcblxuICAgIH1cbik7XG4iXX0=