'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.formatMsg = formatMsg;
exports.uniqueMsg = uniqueMsg;
exports.getCandidates = getCandidates;
exports.getIgnorePatterns = getIgnorePatterns;
exports.isIgnored = isIgnored;
exports.getLineContent = getLineContent;
exports.changeColorByIndex = changeColorByIndex;
exports.changeColorByStartAndEndIndex = changeColorByStartAndEndIndex;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _fs = require('fs');

var _edpCore = require('edp-core');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

'use strict';

/**
 * 调用给定的迭代函数 n 次,每一次传递 index 参数，调用迭代函数。
 * from underscore
 *
 * @param {number} n 迭代次数
 * @param {Function} iterator 处理函数
 * @param {Object} context 上下文
 *
 * @return {Array} 结果
 */
/**
 * @file 通用方法
 * @author ielgnaw(wuji0223@gmail.com)
 */

function times(n, iterator, context) {
    var accum = new Array(Math.max(0, n));
    for (var i = 0; i < n; i++) {
        accum[i] = iterator.call(context, i);
    }
    return accum;
}

/**
 * 格式化信息
 *
 * @param {string} msg 输出的信息
 * @param {number} spaceCount 信息前面空格的个数即缩进的长度
 *
 * @return {string} 格式化后的信息
 */
function formatMsg(msg) {
    var spaceCount = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

    var space = '';
    times(spaceCount, function () {
        space += ' ';
    });
    return space + msg;
}

/**
 * 去掉 error.messages 里面重复的信息
 *
 * @param {Array} msg error.messages
 *
 * @return {Array} 结果数组，是一个新数组
 */
function uniqueMsg(msg) {
    var ret = [];
    var tmp = [];
    for (var i = 0, j = 1, len = msg.length; i < len; i++, j++) {
        var cur = msg[i];
        if (!cur.uniqueFlag) {
            ret.push(cur);
        } else {
            if (tmp.indexOf(cur.uniqueFlag) === -1) {
                tmp.push(cur.uniqueFlag);
                ret.push(cur);
            }
        }
    }
    return ret;
}

/**
 * 根据参数以及模式匹配相应的文件
 *
 * @param {Array} args 文件
 * @param {Array} patterns minimatch 模式
 *
 * @return {Array.<string>} 匹配的文件集合
 */
function getCandidates(args, patterns) {
    var candidates = [];

    args = args.filter(function (item) {
        return item !== '.';
    });

    if (!args.length) {
        candidates = _edpCore.glob.sync(patterns);
    } else {
        var i = -1;
        var len = args.length;
        while (++i < len) {
            var target = args[i];
            if (!(0, _fs.existsSync)(target)) {
                _edpCore.log.warn('No such file or directory %s', target);
                continue;
            }

            var stat = (0, _fs.statSync)(target);
            if (stat.isDirectory()) {
                target = target.replace(/[\/|\\]+$/, '');
                candidates.push.apply(candidates, _edpCore.glob.sync(target + '/' + patterns[0]));
            }
            /* istanbul ignore else */
            else if (stat.isFile()) {
                    candidates.push(target);
                }
        }
    }

    return candidates;
}

/**
 * 获取忽略的 pattern
 *
 * @param {string} file 文件路径
 *
 * @return {Array.<string>} 结果
 */
function getIgnorePatterns(file) {
    if (!(0, _fs.existsSync)(file)) {
        return [];
    }

    var patterns = (0, _fs.readFileSync)(file, 'utf-8').split(/\r?\n/g);
    return patterns.filter(function (item) {
        return item.trim().length > 0 && item[0] !== '#';
    });
}

var _IGNORE_CACHE = {};

/**
 * 判断一下是否应该忽略这个文件.
 *
 * @param {string} file 需要检查的文件路径.
 * @param {string=} name ignore文件的名称.
 * @return {boolean}
 */
function isIgnored(file) {
    var name = arguments.length <= 1 || arguments[1] === undefined ? '.jshintignore' : arguments[1];

    var ignorePatterns = null;

    file = _edpCore.path.resolve(file);

    var key = name + '@' + _edpCore.path.dirname(file);
    if (_IGNORE_CACHE[key]) {
        ignorePatterns = _IGNORE_CACHE[key];
    } else {
        var options = {
            name: name,
            factory: function factory(item) {
                var config = {};
                getIgnorePatterns(item).forEach(function (line) {
                    config[line] = true;
                });
                return config;
            }
        };
        ignorePatterns = _edpCore.util.getConfig(_edpCore.path.dirname(file), options);

        _IGNORE_CACHE[key] = ignorePatterns;
    }

    var bizOrPkgRoot = process.cwd();

    try {
        bizOrPkgRoot = _edpCore.path.getRootDirectory();
    } catch (ex) {}

    var dirname = _edpCore.path.relative(bizOrPkgRoot, file);
    var isMatch = _edpCore.glob.match(dirname, Object.keys(ignorePatterns));

    return isMatch;
}

/**
 * 根据行号获取当前行的内容
 *
 * @param {number} line 行号
 * @param {string} fileData 文件内容
 * @param {boolean} notRemoveSpace 不去掉前面的空格，为 true，则不去掉，为 false 则去掉
 *                                 这是后加的参数，为了兼容之前的代码
 *
 * @return {string} 当前行内容
 */
function getLineContent(line, fileData, notRemoveSpace) {
    if (notRemoveSpace) {
        return fileData.split('\n')[line - 1];
    }
    // 去掉前面的缩进
    return fileData.split('\n')[line - 1].replace(/^\s*/, '');
}

/**
 * 根据索引把一行内容中的某个子串变色
 * 直接用正则匹配的话，可能会把这一行所有的 colorStr 给变色，所以要通过索引来判断
 *
 * @param {string} source 源字符串
 * @param {number} startIndex 开始的索引，通常是 col
 * @param {string} colorStr 要变色的字符串
 *
 * @return {string} 改变颜色后的字符串
 */
function changeColorByIndex(source, startIndex, colorStr) {
    var ret = '';
    if (source) {
        var colorStrLen = colorStr.length;
        var endIndex = startIndex + colorStrLen;
        ret = '' + source.slice(0, startIndex) // colorStr 前面的部分
        + _chalk2.default.magenta(source.slice(startIndex, endIndex)) // colorStr 的部分
        + source.slice(endIndex, source.length); // colorStr 后面的部分
    }
    return ret;
}

/**
 * 根据开始和结束的索引来高亮字符串的子串
 *
 * @param {string} source 源字符串
 * @param {number} startIndex 开始的索引
 * @param {number} endIndex 结束的索引
 *
 * @return {string} 改变颜色后的字符串
 */
function changeColorByStartAndEndIndex(source) {
    var startIndex = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];
    var endIndex = arguments.length <= 2 || arguments[2] === undefined ? 0 : arguments[2];

    if (!source) {
        return '';
    }

    startIndex -= 1;
    endIndex -= 1;

    return '' + source.slice(0, startIndex) // colorStr 前面的部分
    + _chalk2.default.magenta(source.slice(startIndex, endIndex)) // colorStr 的部分
    + source.slice(endIndex, source.length); // colorStr 后面的部分
}

/**
 * 把错误信息放入 errors 数组中
 *
 * @param {string} ruleName 规则名称
 * @param {number} line 行号
 * @param {number} col 列号
 * @param {string} message 错误信息
 * @param {string} colorMessage 彩色错误信息
 */
// function addInvalidList(ruleName, line, col, message, colorMessage) {
//     this.push({
//         ruleName: ruleName,
//         line: line,
//         col: col,
//         message: message,
//         colorMessage: colorMessage
//     });
// }
//# sourceMappingURL=data:application/json;base64,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QWIsRUFBdUIsT0FBTyxNQUE5QixDQUhOLENBSFEsQ0FNcUM7QUFDaEQ7QUFDRCxXQUFPLEdBQVA7QUFDSDs7QUFFRDs7Ozs7Ozs7O0FBU08sU0FBUyw2QkFBVCxDQUF1QyxNQUF2QyxFQUE2RTtBQUFBLFFBQTlCLFVBQThCLHlEQUFqQixDQUFpQjtBQUFBLFFBQWQsUUFBYyx5REFBSCxDQUFHOztBQUNoRixRQUFJLENBQUMsTUFBTCxFQUFhO0FBQ1QsZUFBTyxFQUFQO0FBQ0g7O0FBRUQsa0JBQWMsQ0FBZDtBQUNBLGdCQUFZLENBQVo7O0FBRUEsV0FBTyxLQUNELE9BQU8sS0FBUCxDQUFhLENBQWIsRUFBZ0IsVUFBaEIsQ0FEQyxDQUMyQjtBQUQzQixNQUVELGdCQUFNLE9BQU4sQ0FBYyxPQUFPLEtBQVAsQ0FBYSxVQUFiLEVBQXlCLFFBQXpCLENBQWQsQ0FGQyxDQUVpRDtBQUZqRCxNQUdELE9BQU8sS0FBUCxDQUFhLFFBQWIsRUFBdUIsT0FBTyxNQUE5QixDQUhOLENBUmdGLENBV25DO0FBQ2hEOztBQUVEOzs7Ozs7Ozs7QUFTQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUg6YCa55So5pa55rOVXG4gKiBAYXV0aG9yIGllbGduYXcod3VqaTAyMjNAZ21haWwuY29tKVxuICovXG5cbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQge3N0YXRTeW5jLCBleGlzdHNTeW5jLCByZWFkRmlsZVN5bmN9IGZyb20gJ2ZzJztcbmltcG9ydCB7Z2xvYiwgbG9nLCB1dGlsIGFzIGVkcFV0aWwsIHBhdGggYXMgZWRwUGF0aH0gZnJvbSAnZWRwLWNvcmUnO1xuXG4ndXNlIHN0cmljdCc7XG5cbi8qKlxuICog6LCD55So57uZ5a6a55qE6L+t5Luj5Ye95pWwIG4g5qyhLOavj+S4gOasoeS8oOmAkiBpbmRleCDlj4LmlbDvvIzosIPnlKjov63ku6Plh73mlbDjgIJcbiAqIGZyb20gdW5kZXJzY29yZVxuICpcbiAqIEBwYXJhbSB7bnVtYmVyfSBuIOi/reS7o+asoeaVsFxuICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0b3Ig5aSE55CG5Ye95pWwXG4gKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCDkuIrkuIvmlodcbiAqXG4gKiBAcmV0dXJuIHtBcnJheX0g57uT5p6cXG4gKi9cbmZ1bmN0aW9uIHRpbWVzKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7XG4gICAgY29uc3QgYWNjdW0gPSBuZXcgQXJyYXkoTWF0aC5tYXgoMCwgbikpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7XG4gICAgICAgIGFjY3VtW2ldID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTtcbiAgICB9XG4gICAgcmV0dXJuIGFjY3VtO1xufVxuXG5cbi8qKlxuICog5qC85byP5YyW5L+h5oGvXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG1zZyDovpPlh7rnmoTkv6Hmga9cbiAqIEBwYXJhbSB7bnVtYmVyfSBzcGFjZUNvdW50IOS/oeaBr+WJjemdouepuuagvOeahOS4quaVsOWNs+e8qei/m+eahOmVv+W6plxuICpcbiAqIEByZXR1cm4ge3N0cmluZ30g5qC85byP5YyW5ZCO55qE5L+h5oGvXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXRNc2cobXNnLCBzcGFjZUNvdW50ID0gMCkge1xuICAgIGxldCBzcGFjZSA9ICcnO1xuICAgIHRpbWVzKHNwYWNlQ291bnQsICgpID0+IHtcbiAgICAgICAgc3BhY2UgKz0gJyAnO1xuICAgIH0pO1xuICAgIHJldHVybiBzcGFjZSArIG1zZztcbn1cblxuLyoqXG4gKiDljrvmjokgZXJyb3IubWVzc2FnZXMg6YeM6Z2i6YeN5aSN55qE5L+h5oGvXG4gKlxuICogQHBhcmFtIHtBcnJheX0gbXNnIGVycm9yLm1lc3NhZ2VzXG4gKlxuICogQHJldHVybiB7QXJyYXl9IOe7k+aenOaVsOe7hO+8jOaYr+S4gOS4quaWsOaVsOe7hFxuICovXG5leHBvcnQgZnVuY3Rpb24gdW5pcXVlTXNnKG1zZykge1xuICAgIGxldCByZXQgPSBbXTtcbiAgICBsZXQgdG1wID0gW107XG4gICAgZm9yIChsZXQgaSA9IDAsIGogPSAxLCBsZW4gPSBtc2cubGVuZ3RoOyBpIDwgbGVuOyBpKyssIGorKykge1xuICAgICAgICBsZXQgY3VyID0gbXNnW2ldO1xuICAgICAgICBpZiAoIWN1ci51bmlxdWVGbGFnKSB7XG4gICAgICAgICAgICByZXQucHVzaChjdXIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRtcC5pbmRleE9mKGN1ci51bmlxdWVGbGFnKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICB0bXAucHVzaChjdXIudW5pcXVlRmxhZyk7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2goY3VyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuXG5cbi8qKlxuICog5qC55o2u5Y+C5pWw5Lul5Y+K5qih5byP5Yy56YWN55u45bqU55qE5paH5Lu2XG4gKlxuICogQHBhcmFtIHtBcnJheX0gYXJncyDmlofku7ZcbiAqIEBwYXJhbSB7QXJyYXl9IHBhdHRlcm5zIG1pbmltYXRjaCDmqKHlvI9cbiAqXG4gKiBAcmV0dXJuIHtBcnJheS48c3RyaW5nPn0g5Yy56YWN55qE5paH5Lu26ZuG5ZCIXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDYW5kaWRhdGVzKGFyZ3MsIHBhdHRlcm5zKSB7XG4gICAgbGV0IGNhbmRpZGF0ZXMgPSBbXTtcblxuICAgIGFyZ3MgPSBhcmdzLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09ICcuJyk7XG5cbiAgICBpZiAoIWFyZ3MubGVuZ3RoKSB7XG4gICAgICAgIGNhbmRpZGF0ZXMgPSBnbG9iLnN5bmMocGF0dGVybnMpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgbGV0IGkgPSAtMTtcbiAgICAgICAgbGV0IGxlbiA9IGFyZ3MubGVuZ3RoO1xuICAgICAgICB3aGlsZSAoKytpIDwgbGVuKSB7XG4gICAgICAgICAgICBsZXQgdGFyZ2V0ID0gYXJnc1tpXTtcbiAgICAgICAgICAgIGlmICghZXhpc3RzU3luYyh0YXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgbG9nLndhcm4oJ05vIHN1Y2ggZmlsZSBvciBkaXJlY3RvcnkgJXMnLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgc3RhdCA9IHN0YXRTeW5jKHRhcmdldCk7XG4gICAgICAgICAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnJlcGxhY2UoL1tcXC98XFxcXF0rJC8sICcnKTtcbiAgICAgICAgICAgICAgICBjYW5kaWRhdGVzLnB1c2guYXBwbHkoXG4gICAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZXMsXG4gICAgICAgICAgICAgICAgICAgIGdsb2Iuc3luYyh0YXJnZXQgKyAnLycgKyBwYXR0ZXJuc1swXSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgICAgICAgIGVsc2UgaWYgKHN0YXQuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICBjYW5kaWRhdGVzLnB1c2godGFyZ2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjYW5kaWRhdGVzO1xufVxuXG4vKipcbiAqIOiOt+WPluW/veeVpeeahCBwYXR0ZXJuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGUg5paH5Lu26Lev5b6EXG4gKlxuICogQHJldHVybiB7QXJyYXkuPHN0cmluZz59IOe7k+aenFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0SWdub3JlUGF0dGVybnMoZmlsZSkge1xuICAgIGlmICghZXhpc3RzU3luYyhmaWxlKSkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgbGV0IHBhdHRlcm5zID0gcmVhZEZpbGVTeW5jKGZpbGUsICd1dGYtOCcpLnNwbGl0KC9cXHI/XFxuL2cpO1xuICAgIHJldHVybiBwYXR0ZXJucy5maWx0ZXIoaXRlbSA9PiBpdGVtLnRyaW0oKS5sZW5ndGggPiAwICYmIGl0ZW1bMF0gIT09ICcjJyk7XG59XG5cbmNvbnN0IF9JR05PUkVfQ0FDSEUgPSB7fTtcblxuLyoqXG4gKiDliKTmlq3kuIDkuIvmmK/lkKblupTor6Xlv73nlaXov5nkuKrmlofku7YuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGUg6ZyA6KaB5qOA5p+l55qE5paH5Lu26Lev5b6ELlxuICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIGlnbm9yZeaWh+S7tueahOWQjeensC5cbiAqIEByZXR1cm4ge2Jvb2xlYW59XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0lnbm9yZWQoZmlsZSwgbmFtZSA9ICcuanNoaW50aWdub3JlJykge1xuICAgIGxldCBpZ25vcmVQYXR0ZXJucyA9IG51bGw7XG5cbiAgICBmaWxlID0gZWRwUGF0aC5yZXNvbHZlKGZpbGUpO1xuXG4gICAgbGV0IGtleSA9IG5hbWUgKyAnQCcgICsgZWRwUGF0aC5kaXJuYW1lKGZpbGUpO1xuICAgIGlmIChfSUdOT1JFX0NBQ0hFW2tleV0pIHtcbiAgICAgICAgaWdub3JlUGF0dGVybnMgPSBfSUdOT1JFX0NBQ0hFW2tleV07XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBmYWN0b3J5KGl0ZW0pIHtcbiAgICAgICAgICAgICAgICBsZXQgY29uZmlnID0ge307XG4gICAgICAgICAgICAgICAgZ2V0SWdub3JlUGF0dGVybnMoaXRlbSkuZm9yRWFjaChsaW5lID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnW2xpbmVdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBpZ25vcmVQYXR0ZXJucyA9IGVkcFV0aWwuZ2V0Q29uZmlnKFxuICAgICAgICAgICAgZWRwUGF0aC5kaXJuYW1lKGZpbGUpLFxuICAgICAgICAgICAgb3B0aW9uc1xuICAgICAgICApO1xuXG4gICAgICAgIF9JR05PUkVfQ0FDSEVba2V5XSA9IGlnbm9yZVBhdHRlcm5zO1xuICAgIH1cblxuICAgIGxldCBiaXpPclBrZ1Jvb3QgPSBwcm9jZXNzLmN3ZCgpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgYml6T3JQa2dSb290ID0gZWRwUGF0aC5nZXRSb290RGlyZWN0b3J5KCk7XG4gICAgfVxuICAgIGNhdGNoIChleCkge1xuICAgIH1cblxuICAgIGNvbnN0IGRpcm5hbWUgPSBlZHBQYXRoLnJlbGF0aXZlKGJpek9yUGtnUm9vdCwgZmlsZSk7XG4gICAgY29uc3QgaXNNYXRjaCA9IGdsb2IubWF0Y2goZGlybmFtZSwgT2JqZWN0LmtleXMoaWdub3JlUGF0dGVybnMpKTtcblxuICAgIHJldHVybiBpc01hdGNoO1xufVxuXG4vKipcbiAqIOagueaNruihjOWPt+iOt+WPluW9k+WJjeihjOeahOWGheWuuVxuICpcbiAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lIOihjOWPt1xuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVEYXRhIOaWh+S7tuWGheWuuVxuICogQHBhcmFtIHtib29sZWFufSBub3RSZW1vdmVTcGFjZSDkuI3ljrvmjonliY3pnaLnmoTnqbrmoLzvvIzkuLogdHJ1Ze+8jOWImeS4jeWOu+aOie+8jOS4uiBmYWxzZSDliJnljrvmjolcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg6L+Z5piv5ZCO5Yqg55qE5Y+C5pWw77yM5Li65LqG5YW85a655LmL5YmN55qE5Luj56CBXG4gKlxuICogQHJldHVybiB7c3RyaW5nfSDlvZPliY3ooYzlhoXlrrlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldExpbmVDb250ZW50KGxpbmUsIGZpbGVEYXRhLCBub3RSZW1vdmVTcGFjZSkge1xuICAgIGlmIChub3RSZW1vdmVTcGFjZSkge1xuICAgICAgICByZXR1cm4gZmlsZURhdGEuc3BsaXQoJ1xcbicpW2xpbmUgLSAxXTtcbiAgICB9XG4gICAgLy8g5Y675o6J5YmN6Z2i55qE57yp6L+bXG4gICAgcmV0dXJuIGZpbGVEYXRhLnNwbGl0KCdcXG4nKVtsaW5lIC0gMV0ucmVwbGFjZSgvXlxccyovLCAnJyk7XG59XG5cbi8qKlxuICog5qC55o2u57Si5byV5oqK5LiA6KGM5YaF5a655Lit55qE5p+Q5Liq5a2Q5Liy5Y+Y6ImyXG4gKiDnm7TmjqXnlKjmraPliJnljLnphY3nmoTor53vvIzlj6/og73kvJrmiorov5nkuIDooYzmiYDmnInnmoQgY29sb3JTdHIg57uZ5Y+Y6Imy77yM5omA5Lul6KaB6YCa6L+H57Si5byV5p2l5Yik5patXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHNvdXJjZSDmupDlrZfnrKbkuLJcbiAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IOW8gOWni+eahOe0ouW8le+8jOmAmuW4uOaYryBjb2xcbiAqIEBwYXJhbSB7c3RyaW5nfSBjb2xvclN0ciDopoHlj5joibLnmoTlrZfnrKbkuLJcbiAqXG4gKiBAcmV0dXJuIHtzdHJpbmd9IOaUueWPmOminOiJsuWQjueahOWtl+espuS4slxuICovXG5leHBvcnQgZnVuY3Rpb24gY2hhbmdlQ29sb3JCeUluZGV4KHNvdXJjZSwgc3RhcnRJbmRleCwgY29sb3JTdHIpIHtcbiAgICBsZXQgcmV0ID0gJyc7XG4gICAgaWYgKHNvdXJjZSkge1xuICAgICAgICBjb25zdCBjb2xvclN0ckxlbiA9IGNvbG9yU3RyLmxlbmd0aDtcbiAgICAgICAgY29uc3QgZW5kSW5kZXggPSBzdGFydEluZGV4ICsgY29sb3JTdHJMZW47XG4gICAgICAgIHJldCA9ICcnXG4gICAgICAgICAgICArIHNvdXJjZS5zbGljZSgwLCBzdGFydEluZGV4KSAvLyBjb2xvclN0ciDliY3pnaLnmoTpg6jliIZcbiAgICAgICAgICAgICsgY2hhbGsubWFnZW50YShzb3VyY2Uuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXgpKSAvLyBjb2xvclN0ciDnmoTpg6jliIZcbiAgICAgICAgICAgICsgc291cmNlLnNsaWNlKGVuZEluZGV4LCBzb3VyY2UubGVuZ3RoKTsgLy8gY29sb3JTdHIg5ZCO6Z2i55qE6YOo5YiGXG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5cbi8qKlxuICog5qC55o2u5byA5aeL5ZKM57uT5p2f55qE57Si5byV5p2l6auY5Lqu5a2X56ym5Liy55qE5a2Q5LiyXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHNvdXJjZSDmupDlrZfnrKbkuLJcbiAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IOW8gOWni+eahOe0ouW8lVxuICogQHBhcmFtIHtudW1iZXJ9IGVuZEluZGV4IOe7k+adn+eahOe0ouW8lVxuICpcbiAqIEByZXR1cm4ge3N0cmluZ30g5pS55Y+Y6aKc6Imy5ZCO55qE5a2X56ym5LiyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjaGFuZ2VDb2xvckJ5U3RhcnRBbmRFbmRJbmRleChzb3VyY2UsIHN0YXJ0SW5kZXggPSAwLCBlbmRJbmRleCA9IDApIHtcbiAgICBpZiAoIXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgc3RhcnRJbmRleCAtPSAxO1xuICAgIGVuZEluZGV4IC09IDE7XG5cbiAgICByZXR1cm4gJydcbiAgICAgICAgKyBzb3VyY2Uuc2xpY2UoMCwgc3RhcnRJbmRleCkgLy8gY29sb3JTdHIg5YmN6Z2i55qE6YOo5YiGXG4gICAgICAgICsgY2hhbGsubWFnZW50YShzb3VyY2Uuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXgpKSAvLyBjb2xvclN0ciDnmoTpg6jliIZcbiAgICAgICAgKyBzb3VyY2Uuc2xpY2UoZW5kSW5kZXgsIHNvdXJjZS5sZW5ndGgpOyAvLyBjb2xvclN0ciDlkI7pnaLnmoTpg6jliIZcbn1cblxuLyoqXG4gKiDmiorplJnor6/kv6Hmga/mlL7lhaUgZXJyb3JzIOaVsOe7hOS4rVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBydWxlTmFtZSDop4TliJnlkI3np7BcbiAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lIOihjOWPt1xuICogQHBhcmFtIHtudW1iZXJ9IGNvbCDliJflj7dcbiAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlIOmUmeivr+S/oeaBr1xuICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yTWVzc2FnZSDlvanoibLplJnor6/kv6Hmga9cbiAqL1xuLy8gZnVuY3Rpb24gYWRkSW52YWxpZExpc3QocnVsZU5hbWUsIGxpbmUsIGNvbCwgbWVzc2FnZSwgY29sb3JNZXNzYWdlKSB7XG4vLyAgICAgdGhpcy5wdXNoKHtcbi8vICAgICAgICAgcnVsZU5hbWU6IHJ1bGVOYW1lLFxuLy8gICAgICAgICBsaW5lOiBsaW5lLFxuLy8gICAgICAgICBjb2w6IGNvbCxcbi8vICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbi8vICAgICAgICAgY29sb3JNZXNzYWdlOiBjb2xvck1lc3NhZ2Vcbi8vICAgICB9KTtcbi8vIH1cbiJdfQ==