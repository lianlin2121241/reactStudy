'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.checkString = checkString;
exports.check = check;

var _path = require('path');

var _fs = require('fs');

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _objectAssign = require('object-assign');

var _objectAssign2 = _interopRequireDefault(_objectAssign);

var _util = require('./util');

var _edpCore = require('edp-core');

var _config = require('./config');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @file checker 针对 css 文件的校验器
 * @author ielgnaw(wuji0223@gmail.com)
 */

'use strict';

/**
 * rule 逻辑实现的文件夹路径
 */
var ruleDir = (0, _path.join)(__dirname, './rule');

/**
 * 检测的默认配置
 *
 * @const
 * @type {Object}
 */
var DEFAULT_CONFIG = (0, _objectAssign2.default)({}, (0, _config.loadConfig)('.', true));

/**
 * 为 max-error 服务的，记录整个的错误个数
 *
 * @type {number}
 */
global.CSSHINT_INVALID_ALL_COUNT = 0;

/**
 * 记录项目级别的 font-family 大小写信息，key 为小写格式，value 为真实的值
 * {'arial': 'Arial'}
 *
 * @type {Object}
 */
global.CSSHINT_FONTFAMILY_CASE_FLAG = {};

/**
 * 匹配行内 csshint key: value, ... 的正则
 *
 * @const
 * @type {RegExp}
 */
var INLINE_PATTERN = /\/\*+\s*\bcsshint[^-disable]\b\s*(.*)\s*\*\//gmi;

/**
 * 分析行内注释
 *
 * @param {string} fileContent 当前检测的文件内容
 * @param {Object} rcConfig 当前检测的文件的检测规则
 *
 * @return {Object} inline Rule
 */
var analyzeInlineRule = function analyzeInlineRule(fileContent, rcConfig) {
    var ret = {};
    var inlineObj = null;
    var match = null;

    /* jshint loopfunc:true */
    /* eslint-disable no-extra-boolean-cast, no-loop-func */
    while (!!(match = INLINE_PATTERN.exec(fileContent))) {
        var matchRules = match[1];
        var jsonStr = matchRules.replace(/([^,]*)(?=:)/g, function (word) {
            if (word) {
                word = word.replace(/\s/g, '');
                return '"' + word + '"';
            }
            return '';
        });
        jsonStr = '{' + jsonStr + '}';

        try {
            inlineObj = JSON.parse(jsonStr);
        } catch (e) {}

        if (inlineObj) {
            /* eslint-disable fecs-use-for-of */
            for (var p in inlineObj) {
                if (rcConfig.hasOwnProperty(p)) {
                    ret[p] = inlineObj[p];
                }
            }
            /* eslint-enable fecs-use-for-of */
        }
    }
    /* eslint-enable no-extra-boolean-cast, no-loop-func */
    return ret;
};

/**
 * 匹配行内 csshint-disable xxx, yyy, zzz 的正则
 *
 * @const
 * @type {RegExp}
 */
var INLINE_DISABLE_PATTERN = /\/\*+\s*\bcsshint\-disable\b\s*([^\*\/]*)\s*\*\//gmi;

/**
 * 分析行内 disable 注释
 *
 * @param {string} fileContent 当前检测的文件内容
 * @param {Object} rcConfig 当前检测的文件的检测规则
 *
 * @return {Object} inline Rule
 */
var analyzeInlineDisableRule = function analyzeInlineDisableRule(fileContent, rcConfig) {
    var ret = {};
    var match = null;
    /* eslint-disable no-extra-boolean-cast */
    while (!!(match = INLINE_DISABLE_PATTERN.exec(fileContent))) {
        var matchedRules = match[1];
        if (matchedRules) {
            var simpleMatchedRules = matchedRules.split(/[^a-z-]/gmi);
            for (var i = 0, len = simpleMatchedRules.length; i < len; i++) {
                simpleMatchedRules[i] && (ret[(0, _util.trim)(simpleMatchedRules[i])] = false);
            }
        } else {
            /* eslint-disable fecs-use-for-of */
            for (var p in rcConfig) {
                if (rcConfig.hasOwnProperty(p)) {
                    ret[p] = false;
                }
            }
            /* eslint-enable fecs-use-for-of */
        }
    }
    /* eslint-enable no-extra-boolean-cast */
    return ret;
};

/**
 * 检测 css 文件内容
 *
 * @param {string} fileContent 文件内容
 * @param {string} filePath 文件路径
 * @param {Object=} rcConfig 检测规则的配置，可选
 *
 * @return {Promise} Promise 回调函数的参数即错误信息的集合 {ruleName, line, col, errorChar, message, colorMessage}
 */
function checkString(fileContent, filePath) {
    var rcConfig = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : DEFAULT_CONFIG;


    global.CSSHINT_FONTFAMILY_CASE_FLAG = {};

    // 这里把文件内容的 \r\n 统一替换成 \n，便于之后获取行号
    fileContent = fileContent.replace(/\r\n?/g, '\n');

    // 行内注释改变规则配置
    var inline = analyzeInlineRule(fileContent, rcConfig);

    // 行内注释取消规则配置
    var inlineDisable = analyzeInlineDisableRule(fileContent, rcConfig);

    var realConfig = _edpCore.util.extend({}, rcConfig, inline, inlineDisable);

    var maxError = parseInt(realConfig['max-error'], 10);

    // maxError 为 0 或者非数字的情况，则表示忽略 maxError 即是最大值
    if (isNaN(maxError) || maxError === 0) {
        maxError = Number.MAX_VALUE;
    }

    // postcss 插件集合即规则检测的文件集合
    var plugins = [];

    Object.getOwnPropertyNames(realConfig).forEach(function (prop) {
        var ruleFilePath = (0, _path.join)(ruleDir, prop) + '.js';
        if ((0, _fs.existsSync)(ruleFilePath)) {
            plugins.push(require((0, _path.join)(ruleDir, prop)).check({
                ruleVal: realConfig[prop],
                // 实际上在 postcss 的 plugin 里面通过 node.source.input.css 也可以拿到文件内容
                // 但是通过这种方式拿到的内容是去掉 BOM 的，因此在检测 no-bom 规则时候会有问题
                // 所以这里把文件的原内容传入进去
                fileContent: fileContent,
                filePath: filePath,
                maxError: maxError
            }));
        }
    });

    // 不合法的信息集合
    var invalidList = [];

    var invalid = {
        path: '',
        messages: []
    };

    var checkPromise = new Promise(function (resolve, reject) {
        (0, _postcss2.default)(plugins).process(fileContent).then(function (result) {
            result.warnings().forEach(function (data) {
                invalid.messages.push({
                    ruleName: data.ruleName,
                    line: data.line,
                    col: data.col,
                    errorChar: data.errorChar || '',
                    message: data.message,
                    colorMessage: data.colorMessage
                });
                if (invalid.path !== filePath) {
                    invalid.path = filePath;
                    invalidList.push(invalid);
                }
            });
            resolve(invalidList);
        }).catch(function (e) {
            var line = e.line;
            // 根据 line 是否存在来判断是 css parse 的错误还是程序的错误
            /* istanbul ignore else */
            if (line) {
                var lineContent = (0, _util.getLineContent)(e.line, fileContent) || '';
                invalid.messages.push({
                    line: e.line,
                    col: e.column,
                    message: '' + 'CssSyntaxError: ' + e.message,
                    colorMessage: '' + _chalk2.default.red('CssSyntaxError <' + e.reason + '>: ') + _chalk2.default.grey((0, _util.changeColorByIndex)(lineContent, 0, lineContent.substring(0, e.column - 1)))
                });
            } else {
                var str = e.toString();
                invalid.messages.push({
                    message: str,
                    colorMessage: _chalk2.default.red(str)
                });
            }

            if (invalid.path !== filePath) {
                invalid.path = filePath;
                invalidList.push(invalid);
            }

            reject(invalidList);
        });
    });

    return checkPromise;
}

/**
 * 校验文件
 *
 * @param {Object} file 包含 path, content 键的对象
 * @param {Array} errors 本分类的错误信息数组
 * @param {Function} done 校验完成的通知回调
 *
 * @return {Function} checkString
 */
function check(file, errors, done) {
    // .csshintignore 中配置的文件是指可以忽略 csshint 的文件
    if ((0, _util.isIgnored)(file.path, '.csshintignore')) {
        done();
        return;
    }

    /**
     * checkString 的 promise 的 reject 和 resolve 的返回值的结构以及处理方式都是一样的
     * reject 指的是 CssSyntaxError 的错误。
     * resolve 代表的是 csshint 检测出来的问题
     *
     * @param {Array.<Object>} invalidList 错误信息集合
     */
    var callback = function callback(invalidList) {
        if (invalidList.length) {
            invalidList.forEach(function (invalid) {
                errors.push({
                    path: invalid.path,
                    messages: invalid.messages
                });
            });
        }
        done();
    };

    return checkString(file.content, file.path, (0, _objectAssign2.default)({}, (0, _config.loadConfig)(file.path, true))).then(callback).catch(callback);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jaGVja2VyLmpzIl0sIm5hbWVzIjpbImNoZWNrU3RyaW5nIiwiY2hlY2siLCJydWxlRGlyIiwiX19kaXJuYW1lIiwiREVGQVVMVF9DT05GSUciLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwiQ1NTSElOVF9GT05URkFNSUxZX0NBU0VfRkxBRyIsIklOTElORV9QQVRURVJOIiwiYW5hbHl6ZUlubGluZVJ1bGUiLCJmaWxlQ29udGVudCIsInJjQ29uZmlnIiwicmV0IiwiaW5saW5lT2JqIiwibWF0Y2giLCJleGVjIiwibWF0Y2hSdWxlcyIsImpzb25TdHIiLCJyZXBsYWNlIiwid29yZCIsIkpTT04iLCJwYXJzZSIsImUiLCJwIiwiaGFzT3duUHJvcGVydHkiLCJJTkxJTkVfRElTQUJMRV9QQVRURVJOIiwiYW5hbHl6ZUlubGluZURpc2FibGVSdWxlIiwibWF0Y2hlZFJ1bGVzIiwic2ltcGxlTWF0Y2hlZFJ1bGVzIiwic3BsaXQiLCJpIiwibGVuIiwibGVuZ3RoIiwiZmlsZVBhdGgiLCJpbmxpbmUiLCJpbmxpbmVEaXNhYmxlIiwicmVhbENvbmZpZyIsImV4dGVuZCIsIm1heEVycm9yIiwicGFyc2VJbnQiLCJpc05hTiIsIk51bWJlciIsIk1BWF9WQUxVRSIsInBsdWdpbnMiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwiZm9yRWFjaCIsInJ1bGVGaWxlUGF0aCIsInByb3AiLCJwdXNoIiwicmVxdWlyZSIsInJ1bGVWYWwiLCJpbnZhbGlkTGlzdCIsImludmFsaWQiLCJwYXRoIiwibWVzc2FnZXMiLCJjaGVja1Byb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInByb2Nlc3MiLCJ0aGVuIiwicmVzdWx0Iiwid2FybmluZ3MiLCJydWxlTmFtZSIsImRhdGEiLCJsaW5lIiwiY29sIiwiZXJyb3JDaGFyIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsImNhdGNoIiwibGluZUNvbnRlbnQiLCJjb2x1bW4iLCJyZWQiLCJyZWFzb24iLCJncmV5Iiwic3Vic3RyaW5nIiwic3RyIiwidG9TdHJpbmciLCJmaWxlIiwiZXJyb3JzIiwiZG9uZSIsImNhbGxiYWNrIiwiY29udGVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFzSmdCQSxXLEdBQUFBLFc7UUFxSEFDLEssR0FBQUEsSzs7QUF0UWhCOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOztBQUNBOztBQUNBOzs7O0FBYkE7Ozs7O0FBZ0JBOztBQUVBOzs7QUFHQSxJQUFNQyxVQUFVLGdCQUFLQyxTQUFMLEVBQWdCLFFBQWhCLENBQWhCOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxpQkFBaUIsNEJBQWEsRUFBYixFQUFpQix3QkFBVyxHQUFYLEVBQWdCLElBQWhCLENBQWpCLENBQXZCOztBQUVBOzs7OztBQUtBQyxPQUFPQyx5QkFBUCxHQUFtQyxDQUFuQzs7QUFFQTs7Ozs7O0FBTUFELE9BQU9FLDRCQUFQLEdBQXNDLEVBQXRDOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxpQkFBaUIsaURBQXZCOztBQUVBOzs7Ozs7OztBQVFBLElBQU1DLG9CQUFvQixTQUFwQkEsaUJBQW9CLENBQUNDLFdBQUQsRUFBY0MsUUFBZCxFQUEyQjtBQUNqRCxRQUFNQyxNQUFNLEVBQVo7QUFDQSxRQUFJQyxZQUFZLElBQWhCO0FBQ0EsUUFBSUMsUUFBUSxJQUFaOztBQUVBO0FBQ0E7QUFDQSxXQUFPLENBQUMsRUFBRUEsUUFBUU4sZUFBZU8sSUFBZixDQUFvQkwsV0FBcEIsQ0FBVixDQUFSLEVBQXFEO0FBQ2pELFlBQU1NLGFBQWFGLE1BQU0sQ0FBTixDQUFuQjtBQUNBLFlBQUlHLFVBQVVELFdBQVdFLE9BQVgsQ0FBbUIsZUFBbkIsRUFBb0MsZ0JBQVE7QUFDdEQsZ0JBQUlDLElBQUosRUFBVTtBQUNOQSx1QkFBT0EsS0FBS0QsT0FBTCxDQUFhLEtBQWIsRUFBb0IsRUFBcEIsQ0FBUDtBQUNBLHVCQUFPLE1BQU1DLElBQU4sR0FBYSxHQUFwQjtBQUNIO0FBQ0QsbUJB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Ozs7O0FBT0EsUUFBTUMsV0FBVyxTQUFYQSxRQUFXLGNBQWU7QUFDNUIsWUFBSS9CLFlBQVlwQixNQUFoQixFQUF3QjtBQUNwQm9CLHdCQUFZTixPQUFaLENBQW9CLG1CQUFXO0FBQzNCbUMsdUJBQU9oQyxJQUFQLENBQVk7QUFDUkssMEJBQU1ELFFBQVFDLElBRE47QUFFUkMsOEJBQVVGLFFBQVFFO0FBRlYsaUJBQVo7QUFJSCxhQUxEO0FBTUg7QUFDRDJCO0FBQ0gsS0FWRDs7QUFZQSxXQUFPbEYsWUFDSGdGLEtBQUtJLE9BREYsRUFFSEosS0FBSzFCLElBRkYsRUFHSCw0QkFBYSxFQUFiLEVBQWlCLHdCQUFXMEIsS0FBSzFCLElBQWhCLEVBQXNCLElBQXRCLENBQWpCLENBSEcsRUFJTE8sSUFKSyxDQUlBc0IsUUFKQSxFQUlVWixLQUpWLENBSWdCWSxRQUpoQixDQUFQO0FBS0giLCJmaWxlIjoiY2hlY2tlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgY2hlY2tlciDpkojlr7kgY3NzIOaWh+S7tueahOagoemqjOWZqFxuICogQGF1dGhvciBpZWxnbmF3KHd1amkwMjIzQGdtYWlsLmNvbSlcbiAqL1xuXG5pbXBvcnQge2pvaW59IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHtleGlzdHNTeW5jfSBmcm9tICdmcyc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IHBvc3Rjc3MgZnJvbSAncG9zdGNzcyc7XG5pbXBvcnQgb2JqZWN0QXNzaWduIGZyb20gJ29iamVjdC1hc3NpZ24nO1xuXG5pbXBvcnQge2lzSWdub3JlZCwgdHJpbSwgZ2V0TGluZUNvbnRlbnQsIGNoYW5nZUNvbG9yQnlJbmRleH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7dXRpbCBhcyBlZHBVdGlsfSBmcm9tICdlZHAtY29yZSc7XG5pbXBvcnQge2xvYWRDb25maWd9IGZyb20gJy4vY29uZmlnJztcblxuXG4ndXNlIHN0cmljdCc7XG5cbi8qKlxuICogcnVsZSDpgLvovpHlrp7njrDnmoTmlofku7blpLnot6/lvoRcbiAqL1xuY29uc3QgcnVsZURpciA9IGpvaW4oX19kaXJuYW1lLCAnLi9ydWxlJyk7XG5cbi8qKlxuICog5qOA5rWL55qE6buY6K6k6YWN572uXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7T2JqZWN0fVxuICovXG5jb25zdCBERUZBVUxUX0NPTkZJRyA9IG9iamVjdEFzc2lnbih7fSwgbG9hZENvbmZpZygnLicsIHRydWUpKTtcblxuLyoqXG4gKiDkuLogbWF4LWVycm9yIOacjeWKoeeahO+8jOiusOW9leaVtOS4queahOmUmeivr+S4quaVsFxuICpcbiAqIEB0eXBlIHtudW1iZXJ9XG4gKi9cbmdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UID0gMDtcblxuLyoqXG4gKiDorrDlvZXpobnnm67nuqfliKvnmoQgZm9udC1mYW1pbHkg5aSn5bCP5YaZ5L+h5oGv77yMa2V5IOS4uuWwj+WGmeagvOW8j++8jHZhbHVlIOS4uuecn+WunueahOWAvFxuICogeydhcmlhbCc6ICdBcmlhbCd9XG4gKlxuICogQHR5cGUge09iamVjdH1cbiAqL1xuZ2xvYmFsLkNTU0hJTlRfRk9OVEZBTUlMWV9DQVNFX0ZMQUcgPSB7fTtcblxuLyoqXG4gKiDljLnphY3ooYzlhoUgY3NzaGludCBrZXk6IHZhbHVlLCAuLi4g55qE5q2j5YiZXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7UmVnRXhwfVxuICovXG5jb25zdCBJTkxJTkVfUEFUVEVSTiA9IC9cXC9cXCorXFxzKlxcYmNzc2hpbnRbXi1kaXNhYmxlXVxcYlxccyooLiopXFxzKlxcKlxcLy9nbWk7XG5cbi8qKlxuICog5YiG5p6Q6KGM5YaF5rOo6YeKXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVDb250ZW50IOW9k+WJjeajgOa1i+eahOaWh+S7tuWGheWuuVxuICogQHBhcmFtIHtPYmplY3R9IHJjQ29uZmlnIOW9k+WJjeajgOa1i+eahOaWh+S7tueahOajgOa1i+inhOWImVxuICpcbiAqIEByZXR1cm4ge09iamVjdH0gaW5saW5lIFJ1bGVcbiAqL1xuY29uc3QgYW5hbHl6ZUlubGluZVJ1bGUgPSAoZmlsZUNvbnRlbnQsIHJjQ29uZmlnKSA9PiB7XG4gICAgY29uc3QgcmV0ID0ge307XG4gICAgbGV0IGlubGluZU9iaiA9IG51bGw7XG4gICAgbGV0IG1hdGNoID0gbnVsbDtcblxuICAgIC8qIGpzaGludCBsb29wZnVuYzp0cnVlICovXG4gICAgLyogZXNsaW50LWRpc2FibGUgbm8tZXh0cmEtYm9vbGVhbi1jYXN0LCBuby1sb29wLWZ1bmMgKi9cbiAgICB3aGlsZSAoISEobWF0Y2ggPSBJTkxJTkVfUEFUVEVSTi5leGVjKGZpbGVDb250ZW50KSkpIHtcbiAgICAgICAgY29uc3QgbWF0Y2hSdWxlcyA9IG1hdGNoWzFdO1xuICAgICAgICBsZXQganNvblN0ciA9IG1hdGNoUnVsZXMucmVwbGFjZSgvKFteLF0qKSg/PTopL2csIHdvcmQgPT4ge1xuICAgICAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICAgICAgICB3b3JkID0gd29yZC5yZXBsYWNlKC9cXHMvZywgJycpO1xuICAgICAgICAgICAgICAgIHJldHVybiAnXCInICsgd29yZCArICdcIic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH0pO1xuICAgICAgICBqc29uU3RyID0gJ3snICsganNvblN0ciArICd9JztcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaW5saW5lT2JqID0gSlNPTi5wYXJzZShqc29uU3RyKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge31cblxuICAgICAgICBpZiAoaW5saW5lT2JqKSB7XG4gICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBmZWNzLXVzZS1mb3Itb2YgKi9cbiAgICAgICAgICAgIGZvciAoY29uc3QgcCBpbiBpbmxpbmVPYmopIHtcbiAgICAgICAgICAgICAgICBpZiAocmNDb25maWcuaGFzT3duUHJvcGVydHkocCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0W3BdID0gaW5saW5lT2JqW3BdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgZmVjcy11c2UtZm9yLW9mICovXG4gICAgICAgIH1cbiAgICB9XG4gICAgLyogZXNsaW50LWVuYWJsZSBuby1leHRyYS1ib29sZWFuLWNhc3QsIG5vLWxvb3AtZnVuYyAqL1xuICAgIHJldHVybiByZXQ7XG59O1xuXG4vKipcbiAqIOWMuemFjeihjOWGhSBjc3NoaW50LWRpc2FibGUgeHh4LCB5eXksIHp6eiDnmoTmraPliJlcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtSZWdFeHB9XG4gKi9cbmNvbnN0IElOTElORV9ESVNBQkxFX1BBVFRFUk4gPSAvXFwvXFwqK1xccypcXGJjc3NoaW50XFwtZGlzYWJsZVxcYlxccyooW15cXCpcXC9dKilcXHMqXFwqXFwvL2dtaTtcblxuLyoqXG4gKiDliIbmnpDooYzlhoUgZGlzYWJsZSDms6jph4pcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZUNvbnRlbnQg5b2T5YmN5qOA5rWL55qE5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge09iamVjdH0gcmNDb25maWcg5b2T5YmN5qOA5rWL55qE5paH5Lu255qE5qOA5rWL6KeE5YiZXG4gKlxuICogQHJldHVybiB7T2JqZWN0fSBpbmxpbmUgUnVsZVxuICovXG5jb25zdCBhbmFseXplSW5saW5lRGlzYWJsZVJ1bGUgPSAoZmlsZUNvbnRlbnQsIHJjQ29uZmlnKSA9PiB7XG4gICAgY29uc3QgcmV0ID0ge307XG4gICAgbGV0IG1hdGNoID0gbnVsbDtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1leHRyYS1ib29sZWFuLWNhc3QgKi9cbiAgICB3aGlsZSAoISEobWF0Y2ggPSBJTkxJTkVfRElTQUJMRV9QQVRURVJOLmV4ZWMoZmlsZUNvbnRlbnQpKSkge1xuICAgICAgICBjb25zdCBtYXRjaGVkUnVsZXMgPSBtYXRjaFsxXTtcbiAgICAgICAgaWYgKG1hdGNoZWRSdWxlcykge1xuICAgICAgICAgICAgY29uc3Qgc2ltcGxlTWF0Y2hlZFJ1bGVzID0gbWF0Y2hlZFJ1bGVzLnNwbGl0KC9bXmEtei1dL2dtaSk7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2ltcGxlTWF0Y2hlZFJ1bGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgc2ltcGxlTWF0Y2hlZFJ1bGVzW2ldICYmIChyZXRbdHJpbShzaW1wbGVNYXRjaGVkUnVsZXNbaV0pXSA9IGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8qIGVzbGludC1kaXNhYmxlIGZlY3MtdXNlLWZvci1vZiAqL1xuICAgICAgICAgICAgZm9yIChjb25zdCBwIGluIHJjQ29uZmlnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJjQ29uZmlnLmhhc093blByb3BlcnR5KHApKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldFtwXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgZmVjcy11c2UtZm9yLW9mICovXG4gICAgICAgIH1cbiAgICB9XG4gICAgLyogZXNsaW50LWVuYWJsZSBuby1leHRyYS1ib29sZWFuLWNhc3QgKi9cbiAgICByZXR1cm4gcmV0O1xufTtcblxuLyoqXG4gKiDmo4DmtYsgY3NzIOaWh+S7tuWGheWuuVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlQ29udGVudCDmlofku7blhoXlrrlcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aCDmlofku7bot6/lvoRcbiAqIEBwYXJhbSB7T2JqZWN0PX0gcmNDb25maWcg5qOA5rWL6KeE5YiZ55qE6YWN572u77yM5Y+v6YCJXG4gKlxuICogQHJldHVybiB7UHJvbWlzZX0gUHJvbWlzZSDlm57osIPlh73mlbDnmoTlj4LmlbDljbPplJnor6/kv6Hmga/nmoTpm4blkIgge3J1bGVOYW1lLCBsaW5lLCBjb2wsIGVycm9yQ2hhciwgbWVzc2FnZSwgY29sb3JNZXNzYWdlfVxuICovXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tTdHJpbmcoZmlsZUNvbnRlbnQsIGZpbGVQYXRoLCByY0NvbmZpZyA9IERFRkFVTFRfQ09ORklHKSB7XG5cbiAgICBnbG9iYWwuQ1NTSElOVF9GT05URkFNSUxZX0NBU0VfRkxBRyA9IHt9O1xuXG4gICAgLy8g6L+Z6YeM5oqK5paH5Lu25YaF5a6555qEIFxcclxcbiDnu5/kuIDmm7/mjaLmiJAgXFxu77yM5L6/5LqO5LmL5ZCO6I635Y+W6KGM5Y+3XG4gICAgZmlsZUNvbnRlbnQgPSBmaWxlQ29udGVudC5yZXBsYWNlKC9cXHJcXG4/L2csICdcXG4nKTtcblxuICAgIC8vIOihjOWGheazqOmHiuaUueWPmOinhOWImemFjee9rlxuICAgIGNvbnN0IGlubGluZSA9IGFuYWx5emVJbmxpbmVSdWxlKGZpbGVDb250ZW50LCByY0NvbmZpZyk7XG5cbiAgICAvLyDooYzlhoXms6jph4rlj5bmtojop4TliJnphY3nva5cbiAgICBjb25zdCBpbmxpbmVEaXNhYmxlID0gYW5hbHl6ZUlubGluZURpc2FibGVSdWxlKGZpbGVDb250ZW50LCByY0NvbmZpZyk7XG5cbiAgICBjb25zdCByZWFsQ29uZmlnID0gZWRwVXRpbC5leHRlbmQoe30sIHJjQ29uZmlnLCBpbmxpbmUsIGlubGluZURpc2FibGUpO1xuXG4gICAgbGV0IG1heEVycm9yID0gcGFyc2VJbnQocmVhbENvbmZpZ1snbWF4LWVycm9yJ10sIDEwKTtcblxuICAgIC8vIG1heEVycm9yIOS4uiAwIOaIluiAhemdnuaVsOWtl+eahOaDheWGte+8jOWImeihqOekuuW/veeVpSBtYXhFcnJvciDljbPmmK/mnIDlpKflgLxcbiAgICBpZiAoaXNOYU4obWF4RXJyb3IpIHx8IG1heEVycm9yID09PSAwKSB7XG4gICAgICAgIG1heEVycm9yID0gTnVtYmVyLk1BWF9WQUxVRTtcbiAgICB9XG5cbiAgICAvLyBwb3N0Y3NzIOaPkuS7tumbhuWQiOWNs+inhOWImeajgOa1i+eahOaWh+S7tumbhuWQiFxuICAgIGNvbnN0IHBsdWdpbnMgPSBbXTtcblxuICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKFxuICAgICAgICByZWFsQ29uZmlnXG4gICAgKS5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICBjb25zdCBydWxlRmlsZVBhdGggPSBqb2luKHJ1bGVEaXIsIHByb3ApICsgJy5qcyc7XG4gICAgICAgIGlmIChleGlzdHNTeW5jKHJ1bGVGaWxlUGF0aCkpIHtcbiAgICAgICAgICAgIHBsdWdpbnMucHVzaChcbiAgICAgICAgICAgICAgICByZXF1aXJlKGpvaW4ocnVsZURpciwgcHJvcCkpLmNoZWNrKHtcbiAgICAgICAgICAgICAgICAgICAgcnVsZVZhbDogcmVhbENvbmZpZ1twcm9wXSxcbiAgICAgICAgICAgICAgICAgICAgLy8g5a6e6ZmF5LiK5ZyoIHBvc3Rjc3Mg55qEIHBsdWdpbiDph4zpnaLpgJrov4cgbm9kZS5zb3VyY2UuaW5wdXQuY3NzIOS5n+WPr+S7peaLv+WIsOaWh+S7tuWGheWuuVxuICAgICAgICAgICAgICAgICAgICAvLyDkvYbmmK/pgJrov4fov5nnp43mlrnlvI/mi7/liLDnmoTlhoXlrrnmmK/ljrvmjokgQk9NIOeahO+8jOWboOatpOWcqOajgOa1iyBuby1ib20g6KeE5YiZ5pe25YCZ5Lya5pyJ6Zeu6aKYXG4gICAgICAgICAgICAgICAgICAgIC8vIOaJgOS7pei/memHjOaKiuaWh+S7tueahOWOn+WGheWuueS8oOWFpei/m+WOu1xuICAgICAgICAgICAgICAgICAgICBmaWxlQ29udGVudDogZmlsZUNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgIGZpbGVQYXRoOiBmaWxlUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgbWF4RXJyb3I6IG1heEVycm9yXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIOS4jeWQiOazleeahOS/oeaBr+mbhuWQiFxuICAgIGNvbnN0IGludmFsaWRMaXN0ID0gW107XG5cbiAgICBjb25zdCBpbnZhbGlkID0ge1xuICAgICAgICBwYXRoOiAnJyxcbiAgICAgICAgbWVzc2FnZXM6IFtdXG4gICAgfTtcblxuICAgIGNvbnN0IGNoZWNrUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgcG9zdGNzcyhwbHVnaW5zKS5wcm9jZXNzKGZpbGVDb250ZW50KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICByZXN1bHQud2FybmluZ3MoKS5mb3JFYWNoKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIGludmFsaWQubWVzc2FnZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBkYXRhLnJ1bGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICBsaW5lOiBkYXRhLmxpbmUsXG4gICAgICAgICAgICAgICAgICAgIGNvbDogZGF0YS5jb2wsXG4gICAgICAgICAgICAgICAgICAgIGVycm9yQ2hhcjogZGF0YS5lcnJvckNoYXIgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGRhdGEubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiBkYXRhLmNvbG9yTWVzc2FnZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChpbnZhbGlkLnBhdGggIT09IGZpbGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGludmFsaWQucGF0aCA9IGZpbGVQYXRoO1xuICAgICAgICAgICAgICAgICAgICBpbnZhbGlkTGlzdC5wdXNoKGludmFsaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzb2x2ZShpbnZhbGlkTGlzdCk7XG4gICAgICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgbGluZSA9IGUubGluZTtcbiAgICAgICAgICAgIC8vIOagueaNriBsaW5lIOaYr+WQpuWtmOWcqOadpeWIpOaWreaYryBjc3MgcGFyc2Ug55qE6ZSZ6K+v6L+Y5piv56iL5bqP55qE6ZSZ6K+vXG4gICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgICAgICAgaWYgKGxpbmUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5lQ29udGVudCA9IGdldExpbmVDb250ZW50KGUubGluZSwgZmlsZUNvbnRlbnQpIHx8ICcnO1xuICAgICAgICAgICAgICAgIGludmFsaWQubWVzc2FnZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGxpbmU6IGUubGluZSxcbiAgICAgICAgICAgICAgICAgICAgY29sOiBlLmNvbHVtbixcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJydcbiAgICAgICAgICAgICAgICAgICAgICAgICsgJ0Nzc1N5bnRheEVycm9yOiAnXG4gICAgICAgICAgICAgICAgICAgICAgICArIGUubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiAnJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5yZWQoJ0Nzc1N5bnRheEVycm9yIDwnICsgZS5yZWFzb24gKyAnPjogJylcbiAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbGsuZ3JleShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb2xvckJ5SW5kZXgobGluZUNvbnRlbnQsIDAsIGxpbmVDb250ZW50LnN1YnN0cmluZygwLCBlLmNvbHVtbiAtIDEpKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RyID0gZS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIGludmFsaWQubWVzc2FnZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHN0cixcbiAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiBjaGFsay5yZWQoc3RyKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaW52YWxpZC5wYXRoICE9PSBmaWxlUGF0aCkge1xuICAgICAgICAgICAgICAgIGludmFsaWQucGF0aCA9IGZpbGVQYXRoO1xuICAgICAgICAgICAgICAgIGludmFsaWRMaXN0LnB1c2goaW52YWxpZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlamVjdChpbnZhbGlkTGlzdCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNoZWNrUHJvbWlzZTtcbn1cblxuLyoqXG4gKiDmoKHpqozmlofku7ZcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZmlsZSDljIXlkKsgcGF0aCwgY29udGVudCDplK7nmoTlr7nosaFcbiAqIEBwYXJhbSB7QXJyYXl9IGVycm9ycyDmnKzliIbnsbvnmoTplJnor6/kv6Hmga/mlbDnu4RcbiAqIEBwYXJhbSB7RnVuY3Rpb259IGRvbmUg5qCh6aqM5a6M5oiQ55qE6YCa55+l5Zue6LCDXG4gKlxuICogQHJldHVybiB7RnVuY3Rpb259IGNoZWNrU3RyaW5nXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjaGVjayhmaWxlLCBlcnJvcnMsIGRvbmUpIHtcbiAgICAvLyAuY3NzaGludGlnbm9yZSDkuK3phY3nva7nmoTmlofku7bmmK/mjIflj6/ku6Xlv73nlaUgY3NzaGludCDnmoTmlofku7ZcbiAgICBpZiAoaXNJZ25vcmVkKGZpbGUucGF0aCwgJy5jc3NoaW50aWdub3JlJykpIHtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY2hlY2tTdHJpbmcg55qEIHByb21pc2Ug55qEIHJlamVjdCDlkowgcmVzb2x2ZSDnmoTov5Tlm57lgLznmoTnu5PmnoTku6Xlj4rlpITnkIbmlrnlvI/pg73mmK/kuIDmoLfnmoRcbiAgICAgKiByZWplY3Qg5oyH55qE5pivIENzc1N5bnRheEVycm9yIOeahOmUmeivr+OAglxuICAgICAqIHJlc29sdmUg5Luj6KGo55qE5pivIGNzc2hpbnQg5qOA5rWL5Ye65p2l55qE6Zeu6aKYXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0FycmF5LjxPYmplY3Q+fSBpbnZhbGlkTGlzdCDplJnor6/kv6Hmga/pm4blkIhcbiAgICAgKi9cbiAgICBjb25zdCBjYWxsYmFjayA9IGludmFsaWRMaXN0ID0+IHtcbiAgICAgICAgaWYgKGludmFsaWRMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgaW52YWxpZExpc3QuZm9yRWFjaChpbnZhbGlkID0+IHtcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHBhdGg6IGludmFsaWQucGF0aCxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXM6IGludmFsaWQubWVzc2FnZXNcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGRvbmUoKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIGNoZWNrU3RyaW5nKFxuICAgICAgICBmaWxlLmNvbnRlbnQsXG4gICAgICAgIGZpbGUucGF0aCxcbiAgICAgICAgb2JqZWN0QXNzaWduKHt9LCBsb2FkQ29uZmlnKGZpbGUucGF0aCwgdHJ1ZSkpXG4gICAgKS50aGVuKGNhbGxiYWNrKS5jYXRjaChjYWxsYmFjayk7XG59XG4iXX0=