'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'fallback-colors';

/* eslint-disable fecs-valid-map-set */
/**
 * @file fallback-colors 的检测逻辑
 *       For older browsers that don't support RGBA, HSL, or HSLA, provide a fallback color
 *       https://github.com/CSSLint/csslint/wiki/Require-fallback-colors
 * @author ielgnaw(wuji0223@gmail.com)
 */

var propertiesToCheck = {
    'color': 1,
    'background': 1,
    'border-color': 1,
    'border-top-color': 1,
    'border-right-color': 1,
    'border-bottom-color': 1,
    'border-left-color': 1,
    'border': 1,
    'border-top': 1,
    'border-right': 1,
    'border-bottom': 1,
    'border-left': 1,
    'background-color': 1
};
/* eslint-enable fecs-valid-map-set */

var lastProperty = void 0;

/**
 * 错误的信息
 *
 * @const
 * @type {string}
 */
var MSG = 'For older browsers that don\'t support RGBA, HSL, or HSLA, provide a fallback color';

/**
 * decl 的处理
 *
 * @param {Object} decl postcss 节点对象
 * @param {Object} result postcss result 对象
 */
var declHandler = function declHandler(decl, result) {
    var prop = decl.prop;
    var value = (0, _util.getPropertyValue)(decl.value);

    var len = value.length;
    var i = 0;
    var colorType = '';

    while (i < len) {
        if (value[i].type === 'color') {
            if ('alpha' in value[i] || 'hue' in value[i]) {
                if (/([^\)]+)\(/.test(value[i].text)) {
                    colorType = RegExp.$1.toUpperCase();
                }

                if (!lastProperty || lastProperty.prop !== prop || lastProperty.colorType !== 'compat') {
                    var source = decl.source;
                    var line = source.start.line;
                    var col = source.start.column;
                    var str = 'Fallback ' + prop + ' (hex or RGB) should precede ' + colorType + ' ' + prop;
                    var colorStr = 'Fallback ' + _chalk2.default.magenta(prop) + ' (hex or RGB) should precede ' + _chalk2.default.magenta(colorType) + ' ' + _chalk2.default.magenta(prop);
                    result.warn(RULENAME, {
                        node: decl,
                        ruleName: RULENAME,
                        line: line,
                        col: col,
                        message: str + MSG,
                        colorMessage: '`' + colorStr + '` ' + _chalk2.default.grey(MSG)
                    });
                    global.CSSHINT_INVALID_ALL_COUNT++;
                }
            } else {
                decl.colorType = 'compat';
            }
        }
        i++;
    }
};

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        if (!opts.ruleVal) {
            return;
        }

        css.walkRules(function (rule) {
            lastProperty = null;

            rule.walkDecls(function (decl) {
                if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                    return;
                }

                if (propertiesToCheck[decl.prop]) {
                    declHandler(decl, result);
                }

                lastProperty = decl;
            });
        });
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL2ZhbGxiYWNrLWNvbG9ycy5qcyJdLCJuYW1lcyI6WyJSVUxFTkFNRSIsInByb3BlcnRpZXNUb0NoZWNrIiwibGFzdFByb3BlcnR5IiwiTVNHIiwiZGVjbEhhbmRsZXIiLCJkZWNsIiwicmVzdWx0IiwicHJvcCIsInZhbHVlIiwibGVuIiwibGVuZ3RoIiwiaSIsImNvbG9yVHlwZSIsInR5cGUiLCJ0ZXN0IiwidGV4dCIsIlJlZ0V4cCIsIiQxIiwidG9VcHBlckNhc2UiLCJzb3VyY2UiLCJsaW5lIiwic3RhcnQiLCJjb2wiLCJjb2x1bW4iLCJzdHIiLCJjb2xvclN0ciIsIm1hZ2VudGEiLCJ3YXJuIiwibm9kZSIsInJ1bGVOYW1lIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsImdyZXkiLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwiY2hlY2siLCJwbHVnaW4iLCJjc3MiLCJvcHRzIiwicnVsZVZhbCIsIndhbGtSdWxlcyIsInJ1bGUiLCJ3YWxrRGVjbHMiLCJtYXhFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQU9BOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUVBOzs7Ozs7QUFNQSxJQUFNQSxXQUFXLGlCQUFqQjs7QUFFQTtBQXBCQTs7Ozs7OztBQXFCQSxJQUFNQyxvQkFBb0I7QUFDdEIsYUFBUyxDQURhO0FBRXRCLGtCQUFjLENBRlE7QUFHdEIsb0JBQWdCLENBSE07QUFJdEIsd0JBQW9CLENBSkU7QUFLdEIsMEJBQXNCLENBTEE7QUFNdEIsMkJBQXVCLENBTkQ7QUFPdEIseUJBQXFCLENBUEM7QUFRdEIsY0FBVSxDQVJZO0FBU3RCLGtCQUFjLENBVFE7QUFVdEIsb0JBQWdCLENBVk07QUFXdEIscUJBQWlCLENBWEs7QUFZdEIsbUJBQWUsQ0FaTztBQWF0Qix3QkFBb0I7QUFiRSxDQUExQjtBQWVBOztBQUVBLElBQUlDLHFCQUFKOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxNQUFNLHFGQUFaOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxjQUFjLFNBQWRBLFdBQWMsQ0FBQ0MsSUFBRCxFQUFPQyxNQUFQLEVBQWtCO0FBQ2xDLFFBQU1DLE9BQU9GLEtBQUtFLElBQWxCO0FBQ0EsUUFBTUMsUUFBUSw0QkFBaUJILEtBQUtHLEtBQXRCLENBQWQ7O0FBRUEsUUFBTUMsTUFBTUQsTUFBTUUsTUFBbEI7QUFDQSxRQUFJQyxJQUFJLENBQVI7QUFDQSxRQUFJQyxZQUFZLEVBQWhCOztBQUVBLFdBQU9ELElBQUlGLEdBQVgsRUFBZ0I7QUFDWixZQUFJRCxNQUFNRyxDQUFOLEVBQVNFLElBQVQsS0FBa0IsT0FBdEIsRUFBK0I7QUFDM0IsZ0JBQUksV0FBV0wsTUFBTUcsQ0FBTixDQUFYLElBQXVCLFNBQVNILE1BQU1HLENBQU4sQ0FBcEMsRUFBOEM7QUFDMUMsb0JBQUksYUFBYUcsSUFBYixDQUFrQk4sTUFBTUcsQ0FBTixFQUFTSSxJQUEzQixDQUFKLEVBQXNDO0FBQ2xDSCxnQ0FBWUksT0FBT0MsRUFBUCxDQUFVQyxXQUFWLEVBQVo7QUFDSDs7QUFFRCxvQkFBSSxDQUFDaEIsWUFBRCxJQUNJQSxhQUFhSyxJQUFiLEtBQXNCQSxJQUF0QixJQUNHTCxhQUFhVSxTQUFiLEtBQTJCLFFBRnRDLEVBR0U7QUFDRSx3QkFBTU8sU0FBU2QsS0FBS2MsTUFBcEI7QUFDQSx3QkFBTUMsT0FBT0QsT0FBT0UsS0FBUCxDQUFhRCxJQUExQjtBQUNBLHdCQUFNRSxNQUFNSCxPQUFPRSxLQUFQLENBQWFFLE1BQXpCO0FBQ0Esd0JBQU1DLE1BQU0sY0FBY2pCLElBQWQsR0FBcUIsK0JBQXJCLEdBQ05LLFNBRE0sR0FDTSxHQUROLEdBQ1lMLElBRHhCO0FBRUEsd0JBQU1rQixXQUFXLGNBQWMsZ0JBQU1DLE9BQU4sQ0FBY25CLElBQWQsQ0FBZCxHQUFvQywrQkFBcEMsR0FDWCxnQkFBTW1CLE9BQU4sQ0FBY2QsU0FBZCxDQURXLEdBQ2dCLEdBRGhCLEdBQ3NCLGdCQUFNYyxPQUFOLENBQWNuQixJQUFkLENBRHZDO0FBRUFELDJCQUFPcUIsSUFBUCxDQUFZM0IsUUFBWixFQUFzQjtBQUNsQjRCLDhCQUFNdkIsSUFEWTtBQUVsQndCLGtDQUFVN0IsUUFGUTtBQUdsQm9CLDhCQUFNQSxJQUhZO0FBSWxCRSw2QkFBS0EsR0FKYTtBQUtsQlEsaUNBQVNOLE1BQU1yQixHQUxHO0FBTWxCNEIsc0NBQWMsTUFDUk4sUUFEUSxHQUVSLElBRlEsR0FHUixnQkFBTU8sSUFBTixDQUFXN0IsR0FBWDtBQVRZLHFCQUF0QjtBQVdBOEIsMkJBQU9DLHlCQUFQO0FBQ0g7QUFDSixhQTdCRCxNQThCSztBQUNEN0IscUJBQUtPLFNBQUwsR0FBaUIsUUFBakI7QUFDSDtBQUNKO0FBQ0REO0FBQ0g7QUFDSixDQTlDRDs7QUFnREE7Ozs7Ozs7O0FBUU8sSUFBTXdCLHdCQUFRLGtCQUFRQyxNQUFSLENBQWVwQyxRQUFmLEVBQXlCO0FBQUEsV0FDMUMsVUFBQ3FDLEdBQUQsRUFBTS9CLE1BQU4sRUFBaUI7QUFDYixZQUFJLENBQUNnQyxLQUFLQyxPQUFWLEVBQW1CO0FBQ2Y7QUFDSDs7QUFFREYsWUFBSUcsU0FBSixDQUFjLGdCQUFRO0FBQ2xCdEMsMkJBQWUsSUFBZjs7QUFFQXVDLGlCQUFLQyxTQUFMLENBQWUsZ0JBQVE7QUFDbkIsb0JBQUlULE9BQU9DLHlCQUFQLElBQW9DSSxLQUFLSyxRQUE3QyxFQUF1RDtBQUNuRDtBQUNIOztBQUVELG9CQUFJMUMsa0JBQWtCSSxLQUFLRSxJQUF2QixDQUFKLEVBQWtDO0FBQzlCSCxnQ0FBWUMsSUFBWixFQUFrQkMsTUFBbEI7QUFDSDs7QUFFREosK0JBQWVHLElBQWY7QUFDSCxhQVZEO0FBWUgsU0FmRDtBQWdCSCxLQXRCeUM7QUFBQSxDQUF6QixDQUFkIiwiZmlsZSI6ImZhbGxiYWNrLWNvbG9ycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgZmFsbGJhY2stY29sb3JzIOeahOajgOa1i+mAu+i+kVxuICogICAgICAgRm9yIG9sZGVyIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBSR0JBLCBIU0wsIG9yIEhTTEEsIHByb3ZpZGUgYSBmYWxsYmFjayBjb2xvclxuICogICAgICAgaHR0cHM6Ly9naXRodWIuY29tL0NTU0xpbnQvY3NzbGludC93aWtpL1JlcXVpcmUtZmFsbGJhY2stY29sb3JzXG4gKiBAYXV0aG9yIGllbGduYXcod3VqaTAyMjNAZ21haWwuY29tKVxuICovXG5cbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgcG9zdGNzcyBmcm9tICdwb3N0Y3NzJztcblxuaW1wb3J0IHtnZXRQcm9wZXJ0eVZhbHVlfSBmcm9tICcuLi91dGlsJztcblxuLyoqXG4gKiDlvZPliY3mlofku7bmiYDku6PooajnmoTop4TliJnlkI3np7BcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IFJVTEVOQU1FID0gJ2ZhbGxiYWNrLWNvbG9ycyc7XG5cbi8qIGVzbGludC1kaXNhYmxlIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuY29uc3QgcHJvcGVydGllc1RvQ2hlY2sgPSB7XG4gICAgJ2NvbG9yJzogMSxcbiAgICAnYmFja2dyb3VuZCc6IDEsXG4gICAgJ2JvcmRlci1jb2xvcic6IDEsXG4gICAgJ2JvcmRlci10b3AtY29sb3InOiAxLFxuICAgICdib3JkZXItcmlnaHQtY29sb3InOiAxLFxuICAgICdib3JkZXItYm90dG9tLWNvbG9yJzogMSxcbiAgICAnYm9yZGVyLWxlZnQtY29sb3InOiAxLFxuICAgICdib3JkZXInOiAxLFxuICAgICdib3JkZXItdG9wJzogMSxcbiAgICAnYm9yZGVyLXJpZ2h0JzogMSxcbiAgICAnYm9yZGVyLWJvdHRvbSc6IDEsXG4gICAgJ2JvcmRlci1sZWZ0JzogMSxcbiAgICAnYmFja2dyb3VuZC1jb2xvcic6IDFcbn07XG4vKiBlc2xpbnQtZW5hYmxlIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuXG5sZXQgbGFzdFByb3BlcnR5O1xuXG4vKipcbiAqIOmUmeivr+eahOS/oeaBr1xuICpcbiAqIEBjb25zdFxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3QgTVNHID0gJ0ZvciBvbGRlciBicm93c2VycyB0aGF0IGRvblxcJ3Qgc3VwcG9ydCBSR0JBLCBIU0wsIG9yIEhTTEEsIHByb3ZpZGUgYSBmYWxsYmFjayBjb2xvcic7XG5cbi8qKlxuICogZGVjbCDnmoTlpITnkIZcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGVjbCBwb3N0Y3NzIOiKgueCueWvueixoVxuICogQHBhcmFtIHtPYmplY3R9IHJlc3VsdCBwb3N0Y3NzIHJlc3VsdCDlr7nosaFcbiAqL1xuY29uc3QgZGVjbEhhbmRsZXIgPSAoZGVjbCwgcmVzdWx0KSA9PiB7XG4gICAgY29uc3QgcHJvcCA9IGRlY2wucHJvcDtcbiAgICBjb25zdCB2YWx1ZSA9IGdldFByb3BlcnR5VmFsdWUoZGVjbC52YWx1ZSk7XG5cbiAgICBjb25zdCBsZW4gPSB2YWx1ZS5sZW5ndGg7XG4gICAgbGV0IGkgPSAwO1xuICAgIGxldCBjb2xvclR5cGUgPSAnJztcblxuICAgIHdoaWxlIChpIDwgbGVuKSB7XG4gICAgICAgIGlmICh2YWx1ZVtpXS50eXBlID09PSAnY29sb3InKSB7XG4gICAgICAgICAgICBpZiAoJ2FscGhhJyBpbiB2YWx1ZVtpXSB8fCAnaHVlJyBpbiB2YWx1ZVtpXSkge1xuICAgICAgICAgICAgICAgIGlmICgvKFteXFwpXSspXFwoLy50ZXN0KHZhbHVlW2ldLnRleHQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbG9yVHlwZSA9IFJlZ0V4cC4kMS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICghbGFzdFByb3BlcnR5XG4gICAgICAgICAgICAgICAgICAgIHx8IChsYXN0UHJvcGVydHkucHJvcCAhPT0gcHJvcFxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgbGFzdFByb3BlcnR5LmNvbG9yVHlwZSAhPT0gJ2NvbXBhdCcpXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGRlY2wuc291cmNlO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gc291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbCA9IHNvdXJjZS5zdGFydC5jb2x1bW47XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0ciA9ICdGYWxsYmFjayAnICsgcHJvcCArICcgKGhleCBvciBSR0IpIHNob3VsZCBwcmVjZWRlICdcbiAgICAgICAgICAgICAgICAgICAgICAgICsgY29sb3JUeXBlICsgJyAnICsgcHJvcDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb3JTdHIgPSAnRmFsbGJhY2sgJyArIGNoYWxrLm1hZ2VudGEocHJvcCkgKyAnIChoZXggb3IgUkdCKSBzaG91bGQgcHJlY2VkZSAnXG4gICAgICAgICAgICAgICAgICAgICAgICArIGNoYWxrLm1hZ2VudGEoY29sb3JUeXBlKSArICcgJyArIGNoYWxrLm1hZ2VudGEocHJvcCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuKFJVTEVOQU1FLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBkZWNsLFxuICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbGluZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbDogY29sLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogc3RyICsgTVNHLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiAnYCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNvbG9yU3RyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KE1TRylcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UKys7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZGVjbC5jb2xvclR5cGUgPSAnY29tcGF0JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpKys7XG4gICAgfVxufTtcblxuLyoqXG4gKiDlhbfkvZPnmoTmo4DmtYvpgLvovpFcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyDlj4LmlbBcbiAqIEBwYXJhbSB7Kn0gb3B0cy5ydWxlVmFsIOW9k+WJjeinhOWImeWFt+S9k+mFjee9rueahOWAvFxuICogQHBhcmFtIHtzdHJpbmd9IG9wdHMuZmlsZUNvbnRlbnQg5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlUGF0aCDmlofku7bot6/lvoRcbiAqL1xuZXhwb3J0IGNvbnN0IGNoZWNrID0gcG9zdGNzcy5wbHVnaW4oUlVMRU5BTUUsIG9wdHMgPT5cbiAgICAoY3NzLCByZXN1bHQpID0+IHtcbiAgICAgICAgaWYgKCFvcHRzLnJ1bGVWYWwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNzcy53YWxrUnVsZXMocnVsZSA9PiB7XG4gICAgICAgICAgICBsYXN0UHJvcGVydHkgPSBudWxsO1xuXG4gICAgICAgICAgICBydWxlLndhbGtEZWNscyhkZWNsID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPj0gb3B0cy5tYXhFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXNUb0NoZWNrW2RlY2wucHJvcF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVjbEhhbmRsZXIoZGVjbCwgcmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsYXN0UHJvcGVydHkgPSBkZWNsO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG4gICAgfVxuKTtcbiJdfQ==