'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

'use strict';

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
/**
 * @file box-model 的检测逻辑
 *       Don't use width or height when using padding or border
 *       https://github.com/CSSLint/csslint/wiki/Beware-of-box-model-size
 * @author ielgnaw(wuji0223@gmail.com)
 */

var RULENAME = 'box-model';

/**
 * 获取宽度的错误信息
 *
 * @param {string} prop 属性名称
 *
 * @return {Object} 错误信息
 */
var getWidthMsg = function getWidthMsg(prop) {
    return {
        str: '' + 'Using width with `' + prop + '` can sometimes make elements larger than you expect',
        colorStr: '' + 'Using width with `' + _chalk2.default.magenta(prop) + '` can sometimes make elements larger than you expect'
    };
};

/**
 * 获取高度的错误信息
 *
 * @param {string} prop 属性名称
 *
 * @return {Object} 错误信息
 */
var getHeightMsg = function getHeightMsg(prop) {
    return {
        str: '' + 'Using height with `' + prop + '` can sometimes make elements larger than you expect',
        colorStr: '' + 'Using height with `' + _chalk2.default.magenta(prop) + '` can sometimes make elements larger than you expect'
    };
};

/* eslint-disable fecs-valid-map-set */
var widthProperties = {
    'border': 1,
    'border-left': 1,
    'border-right': 1,
    'padding': 1,
    'padding-left': 1,
    'padding-right': 1
};

var heightProperties = {
    'border': 1,
    'border-bottom': 1,
    'border-top': 1,
    'padding': 1,
    'padding-bottom': 1,
    'padding-top': 1
};
/* eslint-enable fecs-valid-map-set */

var properties = {};
var boxSizing = false;

var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        if (!opts.ruleVal) {
            return;
        }

        css.walkRules(function (rule) {
            /* jshint maxstatements: 27 */
            properties = {};
            boxSizing = false;

            rule.walkDecls(function (decl) {
                if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                    return;
                }

                var prop = decl.prop,
                    value = decl.value;


                if (heightProperties[prop] || widthProperties[prop]) {
                    if (!/^0\S*$/.test(value) && !(prop === 'border' && value.toString() === 'none')) {
                        properties[prop] = decl;
                    }
                } else {
                    if (/^(width|height)/i.test(prop) && /^(length|percentage)/.test((0, _util.getPropertyValue)(value)[0].type)) {
                        properties[prop] = 1;
                    } else if (prop === 'box-sizing') {
                        boxSizing = true;
                    }
                }
            });

            if (boxSizing) {
                return;
            }

            if (properties.height) {
                /* eslint-disable fecs-use-for-of, fecs-valid-map-set */
                for (var hp in heightProperties) {
                    if (heightProperties.hasOwnProperty(hp) && properties[hp]) {
                        var hpValue = properties[hp].value;
                        var hpValueParts = _postcss2.default.list.space(hpValue);
                        // 排除 padding: 0 10px; 这样的情况
                        if (!(hp === 'padding' && hpValueParts.length === 2 && parseInt(hpValueParts[0], 10) === 0)) {
                            var hSource = properties[hp].source;
                            var hLine = hSource.start.line;
                            var hMsg = getHeightMsg(hp);
                            result.warn(RULENAME, {
                                node: properties[hp],
                                ruleName: RULENAME,
                                line: hLine,
                                message: hMsg.str,
                                colorMessage: hMsg.colorStr
                            });
                            global.CSSHINT_INVALID_ALL_COUNT++;
                        }
                    }
                }
                /* eslint-enable fecs-use-for-of, fecs-valid-map-set */
            }

            if (properties.width) {
                /* eslint-disable fecs-use-for-of, fecs-valid-map-set */
                for (var wp in widthProperties) {
                    if (widthProperties.hasOwnProperty(wp) && properties[wp]) {
                        var wpValue = properties[wp].value;
                        var wpValueParts = _postcss2.default.list.space(wpValue);
                        // 排除 padding: 10px 0; 这样的情况
                        if (!(wp === 'padding' && wpValueParts.length === 2 && parseInt(wpValueParts[1], 10) === 0)) {
                            var wSource = properties[wp].source;
                            var wLine = wSource.start.line;
                            var wMsg = getWidthMsg(wp);
                            result.warn(RULENAME, {
                                node: properties[wp],
                                ruleName: RULENAME,
                                line: wLine,
                                message: wMsg.str,
                                colorMessage: wMsg.colorStr
                            });
                            global.CSSHINT_INVALID_ALL_COUNT++;
                        }
                    }
                }
                /* eslint-enable fecs-use-for-of, fecs-valid-map-set */
            }
        });
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL2JveC1tb2RlbC5qcyJdLCJuYW1lcyI6WyJSVUxFTkFNRSIsImdldFdpZHRoTXNnIiwic3RyIiwicHJvcCIsImNvbG9yU3RyIiwibWFnZW50YSIsImdldEhlaWdodE1zZyIsIndpZHRoUHJvcGVydGllcyIsImhlaWdodFByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiYm94U2l6aW5nIiwiY2hlY2siLCJwbHVnaW4iLCJjc3MiLCJyZXN1bHQiLCJvcHRzIiwicnVsZVZhbCIsIndhbGtSdWxlcyIsInJ1bGUiLCJ3YWxrRGVjbHMiLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwibWF4RXJyb3IiLCJkZWNsIiwidmFsdWUiLCJ0ZXN0IiwidG9TdHJpbmciLCJ0eXBlIiwiaGVpZ2h0IiwiaHAiLCJoYXNPd25Qcm9wZXJ0eSIsImhwVmFsdWUiLCJocFZhbHVlUGFydHMiLCJsaXN0Iiwic3BhY2UiLCJsZW5ndGgiLCJwYXJzZUludCIsImhTb3VyY2UiLCJzb3VyY2UiLCJoTGluZSIsInN0YXJ0IiwibGluZSIsImhNc2ciLCJ3YXJuIiwibm9kZSIsInJ1bGVOYW1lIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsIndpZHRoIiwid3AiLCJ3cFZhbHVlIiwid3BWYWx1ZVBhcnRzIiwid1NvdXJjZSIsIndMaW5lIiwid01zZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQU9BOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUVBOztBQUVBOzs7Ozs7QUFkQTs7Ozs7OztBQW9CQSxJQUFNQSxXQUFXLFdBQWpCOztBQUVBOzs7Ozs7O0FBT0EsSUFBTUMsY0FBYyxTQUFkQSxXQUFjLE9BQVE7QUFDeEIsV0FBTztBQUNIQyxhQUFLLEtBQ0Msb0JBREQsR0FFQ0MsSUFGRCxHQUdDLHNEQUpIO0FBS0hDLGtCQUFVLEtBQ0osb0JBREksR0FFSixnQkFBTUMsT0FBTixDQUFjRixJQUFkLENBRkksR0FHSjtBQVJILEtBQVA7QUFVSCxDQVhEOztBQWFB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R0FKSTtBQUtsQjZDLDhDQUFjTyxLQUFLbEQ7QUFMRCw2QkFBdEI7QUFPQWdCLG1DQUFPQyx5QkFBUDtBQUNIO0FBQ0o7QUFDSjtBQUNEO0FBQ0g7QUFDSixTQWxGRDtBQW1GSCxLQXpGeUM7QUFBQSxDQUF6QixDQUFkIiwiZmlsZSI6ImJveC1tb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgYm94LW1vZGVsIOeahOajgOa1i+mAu+i+kVxuICogICAgICAgRG9uJ3QgdXNlIHdpZHRoIG9yIGhlaWdodCB3aGVuIHVzaW5nIHBhZGRpbmcgb3IgYm9yZGVyXG4gKiAgICAgICBodHRwczovL2dpdGh1Yi5jb20vQ1NTTGludC9jc3NsaW50L3dpa2kvQmV3YXJlLW9mLWJveC1tb2RlbC1zaXplXG4gKiBAYXV0aG9yIGllbGduYXcod3VqaTAyMjNAZ21haWwuY29tKVxuICovXG5cbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgcG9zdGNzcyBmcm9tICdwb3N0Y3NzJztcblxuaW1wb3J0IHtnZXRQcm9wZXJ0eVZhbHVlfSBmcm9tICcuLi91dGlsJztcblxuJ3VzZSBzdHJpY3QnO1xuXG4vKipcbiAqIOW9k+WJjeaWh+S7tuaJgOS7o+ihqOeahOinhOWImeWQjeensFxuICpcbiAqIEBjb25zdFxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3QgUlVMRU5BTUUgPSAnYm94LW1vZGVsJztcblxuLyoqXG4gKiDojrflj5blrr3luqbnmoTplJnor6/kv6Hmga9cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcHJvcCDlsZ7mgKflkI3np7BcbiAqXG4gKiBAcmV0dXJuIHtPYmplY3R9IOmUmeivr+S/oeaBr1xuICovXG5jb25zdCBnZXRXaWR0aE1zZyA9IHByb3AgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICAgIHN0cjogJydcbiAgICAgICAgICAgICsgJ1VzaW5nIHdpZHRoIHdpdGggYCdcbiAgICAgICAgICAgICsgcHJvcFxuICAgICAgICAgICAgKyAnYCBjYW4gc29tZXRpbWVzIG1ha2UgZWxlbWVudHMgbGFyZ2VyIHRoYW4geW91IGV4cGVjdCcsXG4gICAgICAgIGNvbG9yU3RyOiAnJ1xuICAgICAgICAgICAgKyAnVXNpbmcgd2lkdGggd2l0aCBgJ1xuICAgICAgICAgICAgKyBjaGFsay5tYWdlbnRhKHByb3ApXG4gICAgICAgICAgICArICdgIGNhbiBzb21ldGltZXMgbWFrZSBlbGVtZW50cyBsYXJnZXIgdGhhbiB5b3UgZXhwZWN0J1xuICAgIH07XG59O1xuXG4vKipcbiAqIOiOt+WPlumrmOW6pueahOmUmeivr+S/oeaBr1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wIOWxnuaAp+WQjeensFxuICpcbiAqIEByZXR1cm4ge09iamVjdH0g6ZSZ6K+v5L+h5oGvXG4gKi9cbmNvbnN0IGdldEhlaWdodE1zZyA9IHByb3AgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICAgIHN0cjogJydcbiAgICAgICAgICAgICsgJ1VzaW5nIGhlaWdodCB3aXRoIGAnXG4gICAgICAgICAgICArIHByb3BcbiAgICAgICAgICAgICsgJ2AgY2FuIHNvbWV0aW1lcyBtYWtlIGVsZW1lbnRzIGxhcmdlciB0aGFuIHlvdSBleHBlY3QnLFxuICAgICAgICBjb2xvclN0cjogJydcbiAgICAgICAgICAgICsgJ1VzaW5nIGhlaWdodCB3aXRoIGAnXG4gICAgICAgICAgICArIGNoYWxrLm1hZ2VudGEocHJvcClcbiAgICAgICAgICAgICsgJ2AgY2FuIHNvbWV0aW1lcyBtYWtlIGVsZW1lbnRzIGxhcmdlciB0aGFuIHlvdSBleHBlY3QnXG4gICAgfTtcbn07XG5cbi8qIGVzbGludC1kaXNhYmxlIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuY29uc3Qgd2lkdGhQcm9wZXJ0aWVzID0ge1xuICAgICdib3JkZXInOiAxLFxuICAgICdib3JkZXItbGVmdCc6IDEsXG4gICAgJ2JvcmRlci1yaWdodCc6IDEsXG4gICAgJ3BhZGRpbmcnOiAxLFxuICAgICdwYWRkaW5nLWxlZnQnOiAxLFxuICAgICdwYWRkaW5nLXJpZ2h0JzogMVxufTtcblxuY29uc3QgaGVpZ2h0UHJvcGVydGllcyA9IHtcbiAgICAnYm9yZGVyJzogMSxcbiAgICAnYm9yZGVyLWJvdHRvbSc6IDEsXG4gICAgJ2JvcmRlci10b3AnOiAxLFxuICAgICdwYWRkaW5nJzogMSxcbiAgICAncGFkZGluZy1ib3R0b20nOiAxLFxuICAgICdwYWRkaW5nLXRvcCc6IDFcbn07XG4vKiBlc2xpbnQtZW5hYmxlIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuXG5sZXQgcHJvcGVydGllcyA9IHt9O1xubGV0IGJveFNpemluZyA9IGZhbHNlO1xuXG5leHBvcnQgY29uc3QgY2hlY2sgPSBwb3N0Y3NzLnBsdWdpbihSVUxFTkFNRSwgb3B0cyA9PlxuICAgIChjc3MsIHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoIW9wdHMucnVsZVZhbCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY3NzLndhbGtSdWxlcyhydWxlID0+IHtcbiAgICAgICAgICAgIC8qIGpzaGludCBtYXhzdGF0ZW1lbnRzOiAyNyAqL1xuICAgICAgICAgICAgcHJvcGVydGllcyA9IHt9O1xuICAgICAgICAgICAgYm94U2l6aW5nID0gZmFsc2U7XG5cbiAgICAgICAgICAgIHJ1bGUud2Fsa0RlY2xzKGRlY2wgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCA+PSBvcHRzLm1heEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCB7cHJvcCwgdmFsdWV9ID0gZGVjbDtcblxuICAgICAgICAgICAgICAgIGlmIChoZWlnaHRQcm9wZXJ0aWVzW3Byb3BdIHx8IHdpZHRoUHJvcGVydGllc1twcm9wXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIS9eMFxcUyokLy50ZXN0KHZhbHVlKSAmJiAhKHByb3AgPT09ICdib3JkZXInICYmIHZhbHVlLnRvU3RyaW5nKCkgPT09ICdub25lJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcF0gPSBkZWNsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoL14od2lkdGh8aGVpZ2h0KS9pLnRlc3QocHJvcClcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIC9eKGxlbmd0aHxwZXJjZW50YWdlKS8udGVzdChnZXRQcm9wZXJ0eVZhbHVlKHZhbHVlKVswXS50eXBlKVxuICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcF0gPSAxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByb3AgPT09ICdib3gtc2l6aW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYm94U2l6aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoYm94U2l6aW5nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvcGVydGllcy5oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBmZWNzLXVzZS1mb3Itb2YsIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaHAgaW4gaGVpZ2h0UHJvcGVydGllcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaGVpZ2h0UHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShocCkgJiYgcHJvcGVydGllc1tocF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhwVmFsdWUgPSBwcm9wZXJ0aWVzW2hwXS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhwVmFsdWVQYXJ0cyA9IHBvc3Rjc3MubGlzdC5zcGFjZShocFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOaOkumZpCBwYWRkaW5nOiAwIDEwcHg7IOi/meagt+eahOaDheWGtVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoaHAgPT09ICdwYWRkaW5nJyAmJiBocFZhbHVlUGFydHMubGVuZ3RoID09PSAyICYmIHBhcnNlSW50KGhwVmFsdWVQYXJ0c1swXSwgMTApID09PSAwKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhTb3VyY2UgPSBwcm9wZXJ0aWVzW2hwXS5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaExpbmUgPSBoU291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaE1zZyA9IGdldEhlaWdodE1zZyhocCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm4oUlVMRU5BTUUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogcHJvcGVydGllc1tocF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogaExpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGhNc2cuc3RyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6IGhNc2cuY29sb3JTdHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgZmVjcy11c2UtZm9yLW9mLCBmZWNzLXZhbGlkLW1hcC1zZXQgKi9cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMud2lkdGgpIHtcbiAgICAgICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBmZWNzLXVzZS1mb3Itb2YsIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgd3AgaW4gd2lkdGhQcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh3aWR0aFByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkod3ApICYmIHByb3BlcnRpZXNbd3BdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3cFZhbHVlID0gcHJvcGVydGllc1t3cF0udmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3cFZhbHVlUGFydHMgPSBwb3N0Y3NzLmxpc3Quc3BhY2Uod3BWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDmjpLpmaQgcGFkZGluZzogMTBweCAwOyDov5nmoLfnmoTmg4XlhrVcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHdwID09PSAncGFkZGluZycgJiYgd3BWYWx1ZVBhcnRzLmxlbmd0aCA9PT0gMiAmJiBwYXJzZUludCh3cFZhbHVlUGFydHNbMV0sIDEwKSA9PT0gMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3U291cmNlID0gcHJvcGVydGllc1t3cF0uc291cmNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdMaW5lID0gd1NvdXJjZS5zdGFydC5saW5lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdNc2cgPSBnZXRXaWR0aE1zZyh3cCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm4oUlVMRU5BTUUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogcHJvcGVydGllc1t3cF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogd0xpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHdNc2cuc3RyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6IHdNc2cuY29sb3JTdHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgZmVjcy11c2UtZm9yLW9mLCBmZWNzLXZhbGlkLW1hcC1zZXQgKi9cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuKTtcbiJdfQ==