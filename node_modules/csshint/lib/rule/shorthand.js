'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'shorthand';

/**
 * 匹配 #aaccaa 之类的颜色值
 *
 * @const
 * @type {RegExp}
 */
/**
 * @file shorthand 的检测逻辑
 *       `property` 对应 015: [建议] 在可以使用缩写的情况下，尽量使用属性缩写。
 *       `color` 对应 030: [强制] 颜色值可以缩写时，必须使用缩写形式。
 * @author ielgnaw(wuji0223@gmail.com)
 */

var PATTERN_COLOR = /^#([\da-f])\1([\da-f])\2([\da-f])\3$/i;

/**
 * 错误的信息
 *
 * @const
 * @type {string}
 */
var COLOR_MSG = 'Color value can be abbreviated, must use the abbreviation form';

var arrayProto = Array.prototype;

var propertiesToCheck = {};

var mapping = {
    margin: ['margin-top', 'margin-bottom', 'margin-left', 'margin-right'],
    padding: ['padding-top', 'padding-bottom', 'padding-left', 'padding-right'],
    font: ['font-family', 'font-size', 'line-height']
};

(function () {
    /* eslint-disable fecs-use-for-of, fecs-valid-map-set */
    for (var prop in mapping) {
        if (mapping.hasOwnProperty(prop)) {
            for (var i = 0, len = mapping[prop].length; i < len; i++) {
                propertiesToCheck[mapping[prop][i]] = prop;
            }
        }
    }
    /* eslint-enable fecs-use-for-of, fecs-valid-map-set */
})();

/**
 * 获取 property 的错误信息
 *
 * @param {string} propertyStr 出错的属性字符串
 * @param {string} selector 这些出错的属性所在的选择器的名称
 * @param {string} replaceProperty 应该要替换的属性
 *
 * @return {Object} 包含 msg 和 colorMsg 属性的对象
 */
var getPropertyMsg = function getPropertyMsg(propertyStr, selector, replaceProperty) {
    return {
        msg: '' + 'The properties `' + propertyStr + '` in the selector `' + selector + '` can be replaced by ' + replaceProperty + '.',
        colorMsg: _chalk2.default.grey('' + 'The properties `' + _chalk2.default.magenta(propertyStr) + '` in the selector `' + _chalk2.default.magenta(selector) + '` can be replaced by ' + _chalk2.default.magenta(replaceProperty) + '.')
    };
};

var lineCache = 0;

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        var ruleVal = opts.ruleVal;
        var realRuleVal = [];
        arrayProto.push[Array.isArray(ruleVal) ? 'apply' : 'call'](realRuleVal, ruleVal);

        if (realRuleVal.length) {
            if (realRuleVal.indexOf('color') > -1) {

                lineCache = 0;

                css.walkDecls(function (decl) {
                    var parts = _postcss2.default.list.space(decl.value);
                    for (var i = 0, len = parts.length; i < len; i++) {
                        var part = parts[i];
                        if (PATTERN_COLOR.test(part)) {
                            var source = decl.source;
                            if (lineCache !== source.start.line) {
                                lineCache = source.start.line;
                                var line = source.start.line;
                                var lineContent = (0, _util.getLineContent)(line, source.input.css);
                                var col = source.start.column + decl.prop.length + decl.raws.between.length;
                                result.warn(RULENAME, {
                                    node: decl,
                                    ruleName: RULENAME,
                                    errorChar: 'color',
                                    line: line,
                                    col: col,
                                    message: COLOR_MSG,
                                    colorMessage: '`' + (0, _util.changeColorByStartAndEndIndex)(lineContent, col, source.end.column) + '` ' + _chalk2.default.grey(COLOR_MSG)
                                });
                                global.CSSHINT_INVALID_ALL_COUNT++;
                            }
                        }
                    }
                });
            }

            if (realRuleVal.indexOf('property') > -1) {
                (function () {
                    var tmp = {};
                    css.walkRules(function (rule) {
                        tmp = {};
                        var nodes = rule.nodes,
                            selector = rule.selector;

                        for (var i = 0, len = nodes.length; i < len; i++) {
                            var decl = nodes[i];
                            if (decl.type === 'decl') {
                                var prop = decl.prop;
                                var v = propertiesToCheck[prop];
                                if (!v) {
                                    continue;
                                }

                                if (!tmp[v]) {
                                    tmp[v] = 1;
                                } else {
                                    tmp[v] += 1;
                                }

                                if (tmp[v] >= mapping[v].length) {
                                    var source = decl.source;
                                    var line = source.start.line;
                                    var col = source.start.column;

                                    var msg = getPropertyMsg(mapping[v].join(', '), selector, v);

                                    result.warn(RULENAME, {
                                        node: decl,
                                        ruleName: RULENAME,
                                        errorChar: 'property',
                                        line: line,
                                        col: col,
                                        message: msg.msg,
                                        colorMessage: msg.colorMsg
                                    });
                                    global.CSSHINT_INVALID_ALL_COUNT++;
                                    break;
                                }
                            }
                        }
                    });
                })();
            }
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3Nob3J0aGFuZC5qcyJdLCJuYW1lcyI6WyJSVUxFTkFNRSIsIlBBVFRFUk5fQ09MT1IiLCJDT0xPUl9NU0ciLCJhcnJheVByb3RvIiwiQXJyYXkiLCJwcm90b3R5cGUiLCJwcm9wZXJ0aWVzVG9DaGVjayIsIm1hcHBpbmciLCJtYXJnaW4iLCJwYWRkaW5nIiwiZm9udCIsInByb3AiLCJoYXNPd25Qcm9wZXJ0eSIsImkiLCJsZW4iLCJsZW5ndGgiLCJnZXRQcm9wZXJ0eU1zZyIsInByb3BlcnR5U3RyIiwic2VsZWN0b3IiLCJyZXBsYWNlUHJvcGVydHkiLCJtc2ciLCJjb2xvck1zZyIsImdyZXkiLCJtYWdlbnRhIiwibGluZUNhY2hlIiwiY2hlY2siLCJwbHVnaW4iLCJjc3MiLCJyZXN1bHQiLCJydWxlVmFsIiwib3B0cyIsInJlYWxSdWxlVmFsIiwicHVzaCIsImlzQXJyYXkiLCJpbmRleE9mIiwid2Fsa0RlY2xzIiwicGFydHMiLCJsaXN0Iiwic3BhY2UiLCJkZWNsIiwidmFsdWUiLCJwYXJ0IiwidGVzdCIsInNvdXJjZSIsInN0YXJ0IiwibGluZSIsImxpbmVDb250ZW50IiwiaW5wdXQiLCJjb2wiLCJjb2x1bW4iLCJyYXdzIiwiYmV0d2VlbiIsIndhcm4iLCJub2RlIiwicnVsZU5hbWUiLCJlcnJvckNoYXIiLCJtZXNzYWdlIiwiY29sb3JNZXNzYWdlIiwiZW5kIiwiZ2xvYmFsIiwiQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCIsInRtcCIsIndhbGtSdWxlcyIsIm5vZGVzIiwicnVsZSIsInR5cGUiLCJ2Iiwiam9pbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQU9BOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUVBOzs7Ozs7QUFNQSxJQUFNQSxXQUFXLFdBQWpCOztBQUVBOzs7Ozs7QUFwQkE7Ozs7Ozs7QUEwQkEsSUFBTUMsZ0JBQWdCLHVDQUF0Qjs7QUFFQTs7Ozs7O0FBTUEsSUFBTUMsWUFBWSxnRUFBbEI7O0FBRUEsSUFBTUMs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QUFDQSxvQ0FBSSxDQUFDdUQsQ0FBTCxFQUFRO0FBQ0o7QUFDSDs7QUFFRCxvQ0FBSSxDQUFDTCxJQUFJSyxDQUFKLENBQUwsRUFBYTtBQUNUTCx3Q0FBSUssQ0FBSixJQUFTLENBQVQ7QUFDSCxpQ0FGRCxNQUdLO0FBQ0RMLHdDQUFJSyxDQUFKLEtBQVUsQ0FBVjtBQUNIOztBQUVELG9DQUFJTCxJQUFJSyxDQUFKLEtBQVUzRCxRQUFRMkQsQ0FBUixFQUFXbkQsTUFBekIsRUFBaUM7QUFDN0Isd0NBQU00QixTQUFTSixLQUFLSSxNQUFwQjtBQUNBLHdDQUFNRSxPQUFPRixPQUFPQyxLQUFQLENBQWFDLElBQTFCO0FBQ0Esd0NBQU1HLE1BQU1MLE9BQU9DLEtBQVAsQ0FBYUssTUFBekI7O0FBRUEsd0NBQU03QixNQUFNSixlQUFlVCxRQUFRMkQsQ0FBUixFQUFXQyxJQUFYLENBQWdCLElBQWhCLENBQWYsRUFBc0NqRCxRQUF0QyxFQUFnRGdELENBQWhELENBQVo7O0FBRUF0QywyQ0FBT3dCLElBQVAsQ0FBWXBELFFBQVosRUFBc0I7QUFDbEJxRCw4Q0FBTWQsSUFEWTtBQUVsQmUsa0RBQVV0RCxRQUZRO0FBR2xCdUQsbURBQVcsVUFITztBQUlsQlYsOENBQU1BLElBSlk7QUFLbEJHLDZDQUFLQSxHQUxhO0FBTWxCUSxpREFBU3BDLElBQUlBLEdBTks7QUFPbEJxQyxzREFBY3JDLElBQUlDO0FBUEEscUNBQXRCO0FBU0FzQywyQ0FBT0MseUJBQVA7QUFDQTtBQUNIO0FBQ0o7QUFDSjtBQUNKLHFCQXhDRDtBQUZzQztBQTJDekM7QUFDSjtBQUNKLEtBeEZ5QztBQUFBLENBQXpCLENBQWQiLCJmaWxlIjoic2hvcnRoYW5kLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBzaG9ydGhhbmQg55qE5qOA5rWL6YC76L6RXG4gKiAgICAgICBgcHJvcGVydHlgIOWvueW6lCAwMTU6IFvlu7rorq5dIOWcqOWPr+S7peS9v+eUqOe8qeWGmeeahOaDheWGteS4i++8jOWwvemHj+S9v+eUqOWxnuaAp+e8qeWGmeOAglxuICogICAgICAgYGNvbG9yYCDlr7nlupQgMDMwOiBb5by65Yi2XSDpopzoibLlgLzlj6/ku6XnvKnlhpnml7bvvIzlv4Xpobvkvb/nlKjnvKnlhpnlvaLlvI/jgIJcbiAqIEBhdXRob3IgaWVsZ25hdyh3dWppMDIyM0BnbWFpbC5jb20pXG4gKi9cblxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwb3N0Y3NzIGZyb20gJ3Bvc3Rjc3MnO1xuXG5pbXBvcnQge2dldExpbmVDb250ZW50LCBjaGFuZ2VDb2xvckJ5U3RhcnRBbmRFbmRJbmRleH0gZnJvbSAnLi4vdXRpbCc7XG5cbi8qKlxuICog5b2T5YmN5paH5Lu25omA5Luj6KGo55qE6KeE5YiZ5ZCN56ewXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBSVUxFTkFNRSA9ICdzaG9ydGhhbmQnO1xuXG4vKipcbiAqIOWMuemFjSAjYWFjY2FhIOS5i+exu+eahOminOiJsuWAvFxuICpcbiAqIEBjb25zdFxuICogQHR5cGUge1JlZ0V4cH1cbiAqL1xuY29uc3QgUEFUVEVSTl9DT0xPUiA9IC9eIyhbXFxkYS1mXSlcXDEoW1xcZGEtZl0pXFwyKFtcXGRhLWZdKVxcMyQvaTtcblxuLyoqXG4gKiDplJnor6/nmoTkv6Hmga9cbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IENPTE9SX01TRyA9ICdDb2xvciB2YWx1ZSBjYW4gYmUgYWJicmV2aWF0ZWQsIG11c3QgdXNlIHRoZSBhYmJyZXZpYXRpb24gZm9ybSc7XG5cbmNvbnN0IGFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGU7XG5cbmNvbnN0IHByb3BlcnRpZXNUb0NoZWNrID0ge307XG5cbmNvbnN0IG1hcHBpbmcgPSB7XG4gICAgbWFyZ2luOiBbXG4gICAgICAgICdtYXJnaW4tdG9wJyxcbiAgICAgICAgJ21hcmdpbi1ib3R0b20nLFxuICAgICAgICAnbWFyZ2luLWxlZnQnLFxuICAgICAgICAnbWFyZ2luLXJpZ2h0J1xuICAgIF0sXG4gICAgcGFkZGluZzogW1xuICAgICAgICAncGFkZGluZy10b3AnLFxuICAgICAgICAncGFkZGluZy1ib3R0b20nLFxuICAgICAgICAncGFkZGluZy1sZWZ0JyxcbiAgICAgICAgJ3BhZGRpbmctcmlnaHQnXG4gICAgXSxcbiAgICBmb250OiBbXG4gICAgICAgICdmb250LWZhbWlseScsXG4gICAgICAgICdmb250LXNpemUnLFxuICAgICAgICAnbGluZS1oZWlnaHQnXG4gICAgXVxufTtcblxuKCgpID0+IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZSBmZWNzLXVzZS1mb3Itb2YsIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuICAgIGZvciAobGV0IHByb3AgaW4gbWFwcGluZykge1xuICAgICAgICBpZiAobWFwcGluZy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IG1hcHBpbmdbcHJvcF0ubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzVG9DaGVja1ttYXBwaW5nW3Byb3BdW2ldXSA9IHByb3A7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyogZXNsaW50LWVuYWJsZSBmZWNzLXVzZS1mb3Itb2YsIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xufSkoKTtcblxuLyoqXG4gKiDojrflj5YgcHJvcGVydHkg55qE6ZSZ6K+v5L+h5oGvXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5U3RyIOWHuumUmeeahOWxnuaAp+Wtl+espuS4slxuICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yIOi/meS6m+WHuumUmeeahOWxnuaAp+aJgOWcqOeahOmAieaLqeWZqOeahOWQjeensFxuICogQHBhcmFtIHtzdHJpbmd9IHJlcGxhY2VQcm9wZXJ0eSDlupTor6XopoHmm7/mjaLnmoTlsZ7mgKdcbiAqXG4gKiBAcmV0dXJuIHtPYmplY3R9IOWMheWQqyBtc2cg5ZKMIGNvbG9yTXNnIOWxnuaAp+eahOWvueixoVxuICovXG5jb25zdCBnZXRQcm9wZXJ0eU1zZyA9IChwcm9wZXJ0eVN0ciwgc2VsZWN0b3IsIHJlcGxhY2VQcm9wZXJ0eSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICAgIG1zZzogJydcbiAgICAgICAgICAgICsgJ1RoZSBwcm9wZXJ0aWVzIGAnXG4gICAgICAgICAgICArIHByb3BlcnR5U3RyXG4gICAgICAgICAgICArICdgIGluIHRoZSBzZWxlY3RvciBgJ1xuICAgICAgICAgICAgKyBzZWxlY3RvclxuICAgICAgICAgICAgKyAnYCBjYW4gYmUgcmVwbGFjZWQgYnkgJ1xuICAgICAgICAgICAgKyByZXBsYWNlUHJvcGVydHlcbiAgICAgICAgICAgICsgJy4nLFxuICAgICAgICBjb2xvck1zZzogY2hhbGsuZ3JleSgnJ1xuICAgICAgICAgICAgKyAnVGhlIHByb3BlcnRpZXMgYCdcbiAgICAgICAgICAgICsgY2hhbGsubWFnZW50YShwcm9wZXJ0eVN0cilcbiAgICAgICAgICAgICsgJ2AgaW4gdGhlIHNlbGVjdG9yIGAnXG4gICAgICAgICAgICArIGNoYWxrLm1hZ2VudGEoc2VsZWN0b3IpXG4gICAgICAgICAgICArICdgIGNhbiBiZSByZXBsYWNlZCBieSAnXG4gICAgICAgICAgICArIGNoYWxrLm1hZ2VudGEocmVwbGFjZVByb3BlcnR5KVxuICAgICAgICAgICAgKyAnLicpXG4gICAgfTtcbn07XG5cbmxldCBsaW5lQ2FjaGUgPSAwO1xuXG4vKipcbiAqIOWFt+S9k+eahOajgOa1i+mAu+i+kVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIOWPguaVsFxuICogQHBhcmFtIHsqfSBvcHRzLnJ1bGVWYWwg5b2T5YmN6KeE5YiZ5YW35L2T6YWN572u55qE5YC8XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlQ29udGVudCDmlofku7blhoXlrrlcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRzLmZpbGVQYXRoIOaWh+S7tui3r+W+hFxuICovXG5leHBvcnQgY29uc3QgY2hlY2sgPSBwb3N0Y3NzLnBsdWdpbihSVUxFTkFNRSwgb3B0cyA9PlxuICAgIChjc3MsIHJlc3VsdCkgPT4ge1xuICAgICAgICBjb25zdCBydWxlVmFsID0gb3B0cy5ydWxlVmFsO1xuICAgICAgICBjb25zdCByZWFsUnVsZVZhbCA9IFtdO1xuICAgICAgICBhcnJheVByb3RvLnB1c2hbQXJyYXkuaXNBcnJheShydWxlVmFsKSA/ICdhcHBseScgOiAnY2FsbCddKHJlYWxSdWxlVmFsLCBydWxlVmFsKTtcblxuICAgICAgICBpZiAocmVhbFJ1bGVWYWwubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAocmVhbFJ1bGVWYWwuaW5kZXhPZignY29sb3InKSA+IC0xKSB7XG5cbiAgICAgICAgICAgICAgICBsaW5lQ2FjaGUgPSAwO1xuXG4gICAgICAgICAgICAgICAgY3NzLndhbGtEZWNscyhkZWNsID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFydHMgPSBwb3N0Y3NzLmxpc3Quc3BhY2UoZGVjbC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwYXJ0cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFBBVFRFUk5fQ09MT1IudGVzdChwYXJ0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGRlY2wuc291cmNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5lQ2FjaGUgIT09IHNvdXJjZS5zdGFydC5saW5lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVDYWNoZSA9IHNvdXJjZS5zdGFydC5saW5lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gc291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmVDb250ZW50ID0gZ2V0TGluZUNvbnRlbnQobGluZSwgc291cmNlLmlucHV0LmNzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbCA9IHNvdXJjZS5zdGFydC5jb2x1bW4gKyBkZWNsLnByb3AubGVuZ3RoICsgZGVjbC5yYXdzLmJldHdlZW4ubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogZGVjbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ2hhcjogJ2NvbG9yJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2w6IGNvbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IENPTE9SX01TRyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFuZ2VDb2xvckJ5U3RhcnRBbmRFbmRJbmRleChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZUNvbnRlbnQsIGNvbCwgc291cmNlLmVuZC5jb2x1bW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KENPTE9SX01TRylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWFsUnVsZVZhbC5pbmRleE9mKCdwcm9wZXJ0eScpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG1wID0ge307XG4gICAgICAgICAgICAgICAgY3NzLndhbGtSdWxlcyhydWxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdG1wID0ge307XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHtub2Rlcywgc2VsZWN0b3J9ID0gcnVsZTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IG5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWNsID0gbm9kZXNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC50eXBlID09PSAnZGVjbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9wID0gZGVjbC5wcm9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHYgPSBwcm9wZXJ0aWVzVG9DaGVja1twcm9wXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0bXBbdl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wW3ZdID0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFt2XSArPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBbdl0gPj0gbWFwcGluZ1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gZGVjbC5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sID0gc291cmNlLnN0YXJ0LmNvbHVtbjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtc2cgPSBnZXRQcm9wZXJ0eU1zZyhtYXBwaW5nW3ZdLmpvaW4oJywgJyksIHNlbGVjdG9yLCB2KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogZGVjbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ2hhcjogJ3Byb3BlcnR5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2w6IGNvbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1zZy5tc2csXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6IG1zZy5jb2xvck1zZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQrKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4pO1xuIl19