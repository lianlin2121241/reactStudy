'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'require-doublequotes';

/**
 * 匹配属性选择器的正则
 *
 * @const
 * @type {RegExp}
 */
/**
 * @file require-doublequotes 的检测逻辑
 *       `attr-selector` 对应 010: [强制] 属性选择器中的值必须用双引号包围。
 *       `text-content` 对应 024: [强制] 文本内容必须用双引号包围。
 * @author ielgnaw(wuji0223@gmail.com)
 */

var PATTERN_ATTR_SELECTOR = /\[.+?\](?::[^\s>+~\.#\[]+)?/;

/**
 * 匹配 css 属性值的 url(...);
 *
 * @const
 * @type {RegExp}
 */
var PATTERN_URI = /url\(["']?([^\)"']+)["']?\)/i;

/**
 * 错误的信息
 *
 * @type {string}
 */
var selectorAttrMsg = 'Attribute selector value must use double quotes';
var textContentMsg = 'Text content value must use double quotes';

var arrayProto = Array.prototype;

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        var ruleVal = opts.ruleVal;
        var realRuleVal = [];
        arrayProto.push[Array.isArray(ruleVal) ? 'apply' : 'call'](realRuleVal, ruleVal);

        if (realRuleVal.length) {

            if (realRuleVal.indexOf('attr-selector') > -1) {
                (function () {
                    var invalidRules = [];
                    css.walkRules(function (rule) {
                        if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                            return;
                        }
                        var cleanSelector = rule.selector.replace(/\(.*\)/, '').replace(/:root/, '');
                        var match = cleanSelector.match(PATTERN_ATTR_SELECTOR);
                        if (match && match.length) {
                            // 判处掉没有 = 的情况，没有 = 就说明就是属性选择器，例如 input[data-test]
                            if (match[0].indexOf('=') > -1) {
                                var quoteMatch = match[0].match(/.*=((['"]).*\2).*/);
                                if (quoteMatch) {
                                    if (quoteMatch[2] !== '"') {
                                        invalidRules.push(rule);
                                    }
                                } else {
                                    invalidRules.push(rule);
                                }
                            }
                        }
                    });

                    invalidRules.forEach(function (invalidRule) {
                        var source = invalidRule.source,
                            selector = invalidRule.selector;

                        var line = source.start.line;
                        var lineContent = (0, _util.getLineContent)(line, source.input.css);
                        var col = source.start.column;
                        result.warn(RULENAME, {
                            node: invalidRule,
                            ruleName: RULENAME,
                            errorChar: 'attr-selector',
                            line: line,
                            col: col,
                            message: selectorAttrMsg,
                            colorMessage: '`' + lineContent.replace(selector, _chalk2.default.magenta(selector)) + '` ' + _chalk2.default.grey(selectorAttrMsg)
                        });
                        global.CSSHINT_INVALID_ALL_COUNT++;
                    });
                })();
            }

            if (realRuleVal.indexOf('text-content') > -1) {
                (function () {
                    var invalidDecls = [];
                    css.walkDecls(function (decl) {
                        if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                            return;
                        }
                        var parts = _postcss2.default.list.comma(decl.value);
                        for (var i = 0, len = parts.length; i < len; i++) {
                            // 排除掉 uri 的情况，例如
                            // background-image: url(data:image/gif;base64,R0lGODlhCAAHAIABAGZmZv...);
                            // background-image: 2px 2px url(data:image/gif;base64,R0lGODlhCAAHAIABAGZmZv...);
                            // background-image: url(data:image/gif;base64,R0lGODlhCAAHAIABAGZmZv...) 2px 2px;
                            if (!PATTERN_URI.test(parts[i])) {
                                var quoteMatch = parts[i].match(/.*(['"]).*\1/i);
                                if (quoteMatch) {
                                    if (quoteMatch[1] !== '"') {
                                        invalidDecls.push(decl);
                                    }
                                }
                            }
                        }
                    });

                    invalidDecls.forEach(function (invalidDecl) {
                        var source = invalidDecl.source;
                        var line = source.start.line;
                        var lineContent = (0, _util.getLineContent)(line, source.input.css);
                        var col = source.start.column + invalidDecl.prop.length + invalidDecl.raws.between.length;
                        result.warn(RULENAME, {
                            node: invalidDecl,
                            ruleName: RULENAME,
                            errorChar: 'text-content',
                            line: line,
                            col: col,
                            message: textContentMsg,
                            colorMessage: '`' + (0, _util.changeColorByStartAndEndIndex)(lineContent, col, source.end.column) + '` ' + _chalk2.default.grey(textContentMsg)
                        });
                        global.CSSHINT_INVALID_ALL_COUNT++;
                    });
                })();
            }
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3JlcXVpcmUtZG91YmxlcXVvdGVzLmpzIl0sIm5hbWVzIjpbIlJVTEVOQU1FIiwiUEFUVEVSTl9BVFRSX1NFTEVDVE9SIiwiUEFUVEVSTl9VUkkiLCJzZWxlY3RvckF0dHJNc2ciLCJ0ZXh0Q29udGVudE1zZyIsImFycmF5UHJvdG8iLCJBcnJheSIsInByb3RvdHlwZSIsImNoZWNrIiwicGx1Z2luIiwiY3NzIiwicmVzdWx0IiwicnVsZVZhbCIsIm9wdHMiLCJyZWFsUnVsZVZhbCIsInB1c2giLCJpc0FycmF5IiwibGVuZ3RoIiwiaW5kZXhPZiIsImludmFsaWRSdWxlcyIsIndhbGtSdWxlcyIsImdsb2JhbCIsIkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQiLCJtYXhFcnJvciIsImNsZWFuU2VsZWN0b3IiLCJydWxlIiwic2VsZWN0b3IiLCJyZXBsYWNlIiwibWF0Y2giLCJxdW90ZU1hdGNoIiwiZm9yRWFjaCIsInNvdXJjZSIsImludmFsaWRSdWxlIiwibGluZSIsInN0YXJ0IiwibGluZUNvbnRlbnQiLCJpbnB1dCIsImNvbCIsImNvbHVtbiIsIndhcm4iLCJub2RlIiwicnVsZU5hbWUiLCJlcnJvckNoYXIiLCJtZXNzYWdlIiwiY29sb3JNZXNzYWdlIiwibWFnZW50YSIsImdyZXkiLCJpbnZhbGlkRGVjbHMiLCJ3YWxrRGVjbHMiLCJwYXJ0cyIsImxpc3QiLCJjb21tYSIsImRlY2wiLCJ2YWx1ZSIsImkiLCJsZW4iLCJ0ZXN0IiwiaW52YWxpZERlY2wiLCJwcm9wIiwicmF3cyIsImJldHdlZW4iLCJlbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFPQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFFQTs7Ozs7O0FBTUEsSUFBTUEsV0FBVyxzQkFBakI7O0FBRUE7Ozs7OztBQXBCQTs7Ozs7OztBQTBCQSxJQUFNQyx3QkFBd0IsNkJBQTlCOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxjQUFjLDhCQUFwQjs7QUFFQTs7Ozs7QUFLQSxJQUFN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bEJ3QywwQ0FBYyxNQUNSLHlDQUNFVCxXQURGLEVBQ2VFLEdBRGYsRUFDb0JOLE9BQU84QixHQUFQLENBQVd2QixNQUQvQixDQURRLEdBSVIsSUFKUSxHQUtSLGdCQUFNUSxJQUFOLENBQVcxQyxjQUFYO0FBWlkseUJBQXRCO0FBY0FpQiwrQkFBT0MseUJBQVA7QUFDSCxxQkFwQkQ7QUF2QjBDO0FBNEM3QztBQUNKO0FBQ0osS0FuR3lDO0FBQUEsQ0FBekIsQ0FBZCIsImZpbGUiOiJyZXF1aXJlLWRvdWJsZXF1b3Rlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgcmVxdWlyZS1kb3VibGVxdW90ZXMg55qE5qOA5rWL6YC76L6RXG4gKiAgICAgICBgYXR0ci1zZWxlY3RvcmAg5a+55bqUIDAxMDogW+W8uuWItl0g5bGe5oCn6YCJ5oup5Zmo5Lit55qE5YC85b+F6aG755So5Y+M5byV5Y+35YyF5Zu044CCXG4gKiAgICAgICBgdGV4dC1jb250ZW50YCDlr7nlupQgMDI0OiBb5by65Yi2XSDmlofmnKzlhoXlrrnlv4XpobvnlKjlj4zlvJXlj7fljIXlm7TjgIJcbiAqIEBhdXRob3IgaWVsZ25hdyh3dWppMDIyM0BnbWFpbC5jb20pXG4gKi9cblxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwb3N0Y3NzIGZyb20gJ3Bvc3Rjc3MnO1xuXG5pbXBvcnQge2dldExpbmVDb250ZW50LCBjaGFuZ2VDb2xvckJ5U3RhcnRBbmRFbmRJbmRleH0gZnJvbSAnLi4vdXRpbCc7XG5cbi8qKlxuICog5b2T5YmN5paH5Lu25omA5Luj6KGo55qE6KeE5YiZ5ZCN56ewXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBSVUxFTkFNRSA9ICdyZXF1aXJlLWRvdWJsZXF1b3Rlcyc7XG5cbi8qKlxuICog5Yy56YWN5bGe5oCn6YCJ5oup5Zmo55qE5q2j5YiZXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7UmVnRXhwfVxuICovXG5jb25zdCBQQVRURVJOX0FUVFJfU0VMRUNUT1IgPSAvXFxbLis/XFxdKD86OlteXFxzPit+XFwuI1xcW10rKT8vO1xuXG4vKipcbiAqIOWMuemFjSBjc3Mg5bGe5oCn5YC855qEIHVybCguLi4pO1xuICpcbiAqIEBjb25zdFxuICogQHR5cGUge1JlZ0V4cH1cbiAqL1xuY29uc3QgUEFUVEVSTl9VUkkgPSAvdXJsXFwoW1wiJ10/KFteXFwpXCInXSspW1wiJ10/XFwpL2k7XG5cbi8qKlxuICog6ZSZ6K+v55qE5L+h5oGvXG4gKlxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3Qgc2VsZWN0b3JBdHRyTXNnID0gJ0F0dHJpYnV0ZSBzZWxlY3RvciB2YWx1ZSBtdXN0IHVzZSBkb3VibGUgcXVvdGVzJztcbmNvbnN0IHRleHRDb250ZW50TXNnID0gJ1RleHQgY29udGVudCB2YWx1ZSBtdXN0IHVzZSBkb3VibGUgcXVvdGVzJztcblxuY29uc3QgYXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZTtcblxuLyoqXG4gKiDlhbfkvZPnmoTmo4DmtYvpgLvovpFcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyDlj4LmlbBcbiAqIEBwYXJhbSB7Kn0gb3B0cy5ydWxlVmFsIOW9k+WJjeinhOWImeWFt+S9k+mFjee9rueahOWAvFxuICogQHBhcmFtIHtzdHJpbmd9IG9wdHMuZmlsZUNvbnRlbnQg5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlUGF0aCDmlofku7bot6/lvoRcbiAqL1xuZXhwb3J0IGNvbnN0IGNoZWNrID0gcG9zdGNzcy5wbHVnaW4oUlVMRU5BTUUsIG9wdHMgPT5cbiAgICAoY3NzLCByZXN1bHQpID0+IHtcbiAgICAgICAgY29uc3QgcnVsZVZhbCA9IG9wdHMucnVsZVZhbDtcbiAgICAgICAgY29uc3QgcmVhbFJ1bGVWYWwgPSBbXTtcbiAgICAgICAgYXJyYXlQcm90by5wdXNoW0FycmF5LmlzQXJyYXkocnVsZVZhbCkgPyAnYXBwbHknIDogJ2NhbGwnXShyZWFsUnVsZVZhbCwgcnVsZVZhbCk7XG5cbiAgICAgICAgaWYgKHJlYWxSdWxlVmFsLmxlbmd0aCkge1xuXG4gICAgICAgICAgICBpZiAocmVhbFJ1bGVWYWwuaW5kZXhPZignYXR0ci1zZWxlY3RvcicpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbnZhbGlkUnVsZXMgPSBbXTtcbiAgICAgICAgICAgICAgICBjc3Mud2Fsa1J1bGVzKHJ1bGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPj0gb3B0cy5tYXhFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsZWFuU2VsZWN0b3IgPSBydWxlLnNlbGVjdG9yLnJlcGxhY2UoL1xcKC4qXFwpLywgJycpLnJlcGxhY2UoLzpyb290LywgJycpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGNsZWFuU2VsZWN0b3IubWF0Y2goUEFUVEVSTl9BVFRSX1NFTEVDVE9SKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoICYmIG1hdGNoLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5Yik5aSE5o6J5rKh5pyJID0g55qE5oOF5Ya177yM5rKh5pyJID0g5bCx6K+05piO5bCx5piv5bGe5oCn6YCJ5oup5Zmo77yM5L6L5aaCIGlucHV0W2RhdGEtdGVzdF1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFswXS5pbmRleE9mKCc9JykgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1b3RlTWF0Y2ggPSBtYXRjaFswXS5tYXRjaCgvLio9KChbJ1wiXSkuKlxcMikuKi8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxdW90ZU1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxdW90ZU1hdGNoWzJdICE9PSAnXCInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZFJ1bGVzLnB1c2gocnVsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpbnZhbGlkUnVsZXMuZm9yRWFjaChpbnZhbGlkUnVsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHtzb3VyY2UsIHNlbGVjdG9yfSA9IGludmFsaWRSdWxlO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gc291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmVDb250ZW50ID0gZ2V0TGluZUNvbnRlbnQobGluZSwgc291cmNlLmlucHV0LmNzcyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbCA9IHNvdXJjZS5zdGFydC5jb2x1bW47XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuKFJVTEVOQU1FLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBpbnZhbGlkUnVsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ2hhcjogJ2F0dHItc2VsZWN0b3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbGluZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbDogY29sLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogc2VsZWN0b3JBdHRyTXNnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiAnYCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGxpbmVDb250ZW50LnJlcGxhY2Uoc2VsZWN0b3IsIGNoYWxrLm1hZ2VudGEoc2VsZWN0b3IpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgJ2AgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbGsuZ3JleShzZWxlY3RvckF0dHJNc2cpXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVhbFJ1bGVWYWwuaW5kZXhPZigndGV4dC1jb250ZW50JykgPiAtMSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGludmFsaWREZWNscyA9IFtdO1xuICAgICAgICAgICAgICAgIGNzcy53YWxrRGVjbHMoZGVjbCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCA+PSBvcHRzLm1heEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFydHMgPSBwb3N0Y3NzLmxpc3QuY29tbWEoZGVjbC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwYXJ0cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5o6S6Zmk5o6JIHVyaSDnmoTmg4XlhrXvvIzkvovlpoJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJhY2tncm91bmQtaW1hZ2U6IHVybChkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhDQUFIQUlBQkFHWm1adi4uLik7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBiYWNrZ3JvdW5kLWltYWdlOiAycHggMnB4IHVybChkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhDQUFIQUlBQkFHWm1adi4uLik7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQ0FBSEFJQUJBR1ptWnYuLi4pIDJweCAycHg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIVBBVFRFUk5fVVJJLnRlc3QocGFydHNbaV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVvdGVNYXRjaCA9IHBhcnRzW2ldLm1hdGNoKC8uKihbJ1wiXSkuKlxcMS9pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocXVvdGVNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocXVvdGVNYXRjaFsxXSAhPT0gJ1wiJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZERlY2xzLnB1c2goZGVjbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGludmFsaWREZWNscy5mb3JFYWNoKGludmFsaWREZWNsID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gaW52YWxpZERlY2wuc291cmNlO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gc291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmVDb250ZW50ID0gZ2V0TGluZUNvbnRlbnQobGluZSwgc291cmNlLmlucHV0LmNzcyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbCA9IHNvdXJjZS5zdGFydC5jb2x1bW4gKyBpbnZhbGlkRGVjbC5wcm9wLmxlbmd0aCArIGludmFsaWREZWNsLnJhd3MuYmV0d2Vlbi5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuKFJVTEVOQU1FLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBpbnZhbGlkRGVjbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ2hhcjogJ3RleHQtY29udGVudCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB0ZXh0Q29udGVudE1zZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFuZ2VDb2xvckJ5U3RhcnRBbmRFbmRJbmRleChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZUNvbnRlbnQsIGNvbCwgc291cmNlLmVuZC5jb2x1bW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KHRleHRDb250ZW50TXNnKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQrKztcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbik7XG4iXX0=